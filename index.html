<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>丹阳裕丰业务管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script>
        // 在加载Tailwind之前先重写控制台警告
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (!(typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production'))) {
                    originalWarn.apply(console, args);
                }


            };
        })();
    </script>
    
    <!-- 全局辅助函数 -->
    <script>
        // 辅助函数：解析数字（移除货币符号和非数字字符）
        function parseNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // 移除货币符号和非数字字符（保留小数点和负号）
                return parseFloat(value.replace(/[^\d.-]/g, '')) || 0;
            }
            return 0;
        }
        
        // 辅助函数：将数字格式化为千分位格式
        function formatNumber(numStr, decimals = 0) {
            // 先移除已有的千分位逗号和货币符号
            const cleanStr = (numStr || '').toString().replace(/[\,¥]/g, '');
            const num = parseFloat(cleanStr);
            if (isNaN(num)) return numStr;
            return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        secondary: '#e5edff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        light: '#f3f4f6',
                        dark: '#374151'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            .sidebar-active {
                @apply bg-white text-primary border-b-4 border-primary;
            }
            .card-hover {
                @apply hover:shadow-lg transition-all duration-300;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-primary font-medium py-2 px-4 rounded transition-all;
            }
            .btn-success {
                @apply bg-success hover:bg-success/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-warning {
                @apply bg-warning hover:bg-warning/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .status-badge {
                @apply px-2 py-1 rounded-full text-xs font-medium text-white;
            }
            .status-pending {
                @apply bg-yellow-500;
            }
            .status-processing {
                @apply bg-blue-500;
            }
            .status-completed {
                @apply bg-green-500;
            }
            .status-cancelled {
                @apply bg-red-500;
            }
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-group {
                @apply mb-4;
            }
            .table-header {
                @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap;
            }
            .table-cell {
                @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
            }
            .table-row {
                @apply hover:bg-gray-50;
            }
            .toast {
                @apply fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg transform transition-all duration-300 translate-x-full opacity-0 z-50;
            }
            .toast.show {
                @apply translate-x-0 opacity-100;
            }
            .toast-success {
                @apply bg-success text-white;
            }
            .toast-danger {
                @apply bg-danger text-white;
            }
            .toast-warning {
                @apply bg-warning text-white;
            }
            .toast-info {
                @apply bg-info text-white;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex flex-col h-screen overflow-hidden">
        <!-- 顶部导航栏（原侧边栏改为水平菜单） -->
        <div class="bg-primary flex-shrink-0">
            <div class="flex items-center justify-between h-16 px-4">
                <div class="flex items-center">
                    <i class="fa fa-industry text-white text-2xl mr-2"></i>
                    <span class="text-white font-bold text-lg">丹阳裕丰业务管理系统</span>
                </div>
            </div>
            <nav class="px-4 pb-2 flex overflow-x-auto">

                <a href="#orders" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mr-1 hover:bg-white/10 whitespace-nowrap" data-target="orders">
                    <span class="mr-2">订单管理</span>
                    <i class="fa fa-shopping-cart w-5 h-5"></i>
                </a>
                <a href="#deliveries" class="sidebar-link sidebar-active flex items-center px-4 py-3 text-sm font-medium rounded-md mr-1 whitespace-nowrap" data-target="deliveries">
                    <span class="mr-2">收发货管理</span>
                    <i class="fa fa-truck w-5 h-5"></i>
                </a>
                <a href="#shipping" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mr-1 hover:bg-white/10 whitespace-nowrap" data-target="shipping">
                    <span class="mr-2">运输管理</span>
                    <i class="fa fa-map-marker w-5 h-5"></i>
                </a>
                <a href="#invoices" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mr-1 hover:bg-white/10 whitespace-nowrap" data-target="invoices">
                    <span class="mr-2">开票收款管理</span>
                    <i class="fa fa-file-text w-5 h-5"></i>
                </a>
                <a href="#customers" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mr-1 hover:bg-white/10 whitespace-nowrap" data-target="customers">
                    <span class="mr-2">客户管理</span>
                    <i class="fa fa-users w-5 h-5"></i>
                </a>

            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm z-10">
                <div class="flex items-center justify-between h-16 px-6">
                    <div class="flex items-center">
                        <button class="md:hidden text-gray-500 focus:outline-none" id="mobile-menu-button">
                            <i class="fa fa-bars text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- 数据管理下拉菜单 -->
                    <div class="relative">
                        <button id="dataManagementBtn" class="flex items-center px-4 py-2 rounded-md text-gray-700 hover:bg-gray-100 focus:outline-none">
                            <i class="fa fa-database mr-2"></i>
                            <span>数据管理</span>
                            <i class="fa fa-angle-down ml-1"></i>
                        </button>
                        <!-- 下拉菜单内容 -->
                        <div id="dataManagementMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                            <button id="backupData" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:outline-none">
                                <i class="fa fa-download mr-2"></i>备份数据
                            </button>
                            <button id="restoreData" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:outline-none">
                                <i class="fa fa-upload mr-2"></i>恢复数据
                            </button>
                        </div>
                        <!-- 文件输入用于恢复数据 -->
                        <input type="file" id="restoreFileInput" accept=".json" class="hidden">
                    </div>

                </div>
            </header>

            <!-- 移动端侧边栏 -->
            <div class="md:hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-40 hidden" id="mobile-menu-overlay">
                <div class="fixed inset-y-0 left-0 max-w-xs w-full bg-primary z-50">
                    <div class="flex items-center justify-between h-16 px-4 bg-primary">
                        <div class="flex items-center">
                            <i class="fa fa-industry text-white text-2xl mr-2"></i>
                            <span class="text-white font-bold text-lg">丹阳裕丰业务管理系统</span>
                        </div>
                        <button class="text-white focus:outline-none" id="mobile-menu-close">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <nav class="mt-5 px-2">

                        <a href="#orders" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mb-1 hover:bg-white/10" data-target="orders">
                            <span class="mr-2">订单管理</span>
                            <i class="fa fa-shopping-cart w-5 h-5"></i>
                        </a>
                        <a href="#deliveries" class="sidebar-link sidebar-active flex items-center px-4 py-3 text-sm font-medium rounded-md mb-1" data-target="deliveries">
                            <span class="mr-2">收发货管理</span>
                            <i class="fa fa-truck w-5 h-5"></i>
                        </a>
                        <a href="#shipping" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mb-1 hover:bg-white/10" data-target="shipping">
                            <span class="mr-2">运输管理</span>
                            <i class="fa fa-map-marker w-5 h-5"></i>
                        </a>
                        <a href="#invoices" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mb-1 hover:bg-white/10" data-target="invoices">
                            <span class="mr-2">开票收款管理</span>
                            <i class="fa fa-file-text w-5 h-5"></i>
                        </a>
                        <a href="#customers" class="sidebar-link flex items-center px-4 py-3 text-sm font-medium text-white rounded-md mb-1 hover:bg-white/10" data-target="customers">
                            <span class="mr-2">客户管理</span>
                            <i class="fa fa-users w-5 h-5"></i>
                        </a>

                    </nav>
                </div>
            </div>

            <!-- 内容区域 -->
            <main class="flex-1 overflow-y-auto p-6">

                <!-- 订单管理 -->
                <div id="orders" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">订单管理</h3>
                            <div class="flex space-x-3">
                                <button class="btn-primary flex items-center" id="add-order-btn">
                                    <i class="fa fa-plus mr-2"></i> 新建订单
                                </button>
                                <button id="ordersDeleteAll" class="btn-danger flex items-center">
                                    <i class="fa fa-trash mr-2"></i> 删除所有记录
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <div class="w-full md:w-auto">
                                    <input type="text" id="orders-search-input" placeholder="搜索订单编号、客户名称..." class="form-input">
                                </div>
                                <div class="w-full md:w-auto">
                                    <select id="orders-status-filter" class="form-input">
                                        <option value="">所有状态</option>
                                        <option value="待电镀">待电镀</option>
                                        <option value="已完成">已完成</option>
                                        <option value="电镀中">电镀中</option>
                                        <option value="报废警告!">报废警告!</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <select id="orders-customer-filter" class="form-input">
                                        <option value="">所有客户</option>
                                        <option value="customer1">深圳科技有限公司</option>
                                        <option value="customer2">广州电子有限公司</option>
                                        <option value="customer3">东莞精密制造有限公司</option>
                                        <option value="customer4">佛山金属制品有限公司</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <div class="flex items-center space-x-2">
                                        <input type="date" id="orders-start-date" class="form-input" placeholder="开始日期">
                                        <span>至</span>
                                        <input type="date" id="orders-end-date" class="form-input" placeholder="结束日期">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto mr-3">
                                    <button id="orders-search-btn" class="btn-primary">
                                        <i class="fa fa-search mr-2"></i> 搜索
                                    </button>
                                </div>
                                <div class="w-full md:w-auto">
                                    <button id="orders-reset-btn" class="btn-secondary">
                                        <i class="fa fa-refresh mr-2"></i> 重置
                                    </button>
                                </div>

                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="ordersTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="table-header">
                                                <input type="checkbox" id="orders-select-all" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </th>
                                            <th scope="col" class="table-header">状态</th>
                                            <th scope="col" class="table-header">滞留数量</th>
                                            <th scope="col" class="table-header">良品数量</th>
                                            <th scope="col" class="table-header">差额</th>
                                            <th scope="col" class="table-header">订单编号</th>
                                            <th scope="col" class="table-header">客户</th>
                                            <th scope="col" class="table-header">订单日期</th>
                                            <th scope="col" class="table-header">交货日期</th>
                                            <th scope="col" class="table-header">电位差等电镀技术要求</th>
                                            <th scope="col" class="table-header">产品名称</th>
                                            <th scope="col" class="table-header">规格</th>
                                            <th scope="col" class="table-header">数量</th>
                                            <th scope="col" class="table-header">单价</th>
                                            <th scope="col" class="table-header">金额</th>
                                            <th scope="col" class="table-header">备注</th>
                                            <th scope="col" class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="ordersTableBody">
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </td>
                                            <td class="table-cell">ORD-2023-0125</td>
                                            <td class="table-cell">深圳科技有限公司</td>
                                            <td class="table-cell">2023-06-15</td>
                                            <td class="table-cell">2023-06-20</td>
                                            <td class="table-cell">要求电位差±0.05V</td>
                                            <td class="table-cell">电路板</td>
                                            <td class="table-cell">10cm×10cm</td>
                                            <td class="table-cell">5000</td>
                                            <td class="table-cell">¥6.5</td>
                                            <td class="table-cell">¥32,500</td>
                                            <td class="table-cell">加急订单</td>
                                            <td class="table-cell">
                                                <span class="status-badge status-processing">处理中</span>
                                            </td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </td>
                                            <td class="table-cell">ORD-2023-0124</td>
                                            <td class="table-cell">广州电子有限公司</td>
                                            <td class="table-cell">2023-06-14</td>
                                            <td class="table-cell">2023-06-19</td>
                                            <td class="table-cell">标准电位差要求</td>
                                            <td class="table-cell">电子元件</td>
                                            <td class="table-cell">5mm×5mm</td>
                                            <td class="table-cell">10000</td>
                                            <td class="table-cell">¥1.87</td>
                                            <td class="table-cell">¥18,700</td>
                                            <td class="table-cell">无特殊要求</td>
                                            <td class="table-cell">
                                                <span class="status-badge status-completed">已完成</span>
                                            </td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </td>
                                            <td class="table-cell">ORD-2023-0123</td>
                                            <td class="table-cell">东莞精密制造有限公司</td>
                                            <td class="table-cell">2023-06-14</td>
                                            <td class="table-cell">2023-06-21</td>
                                            <td class="table-cell">电位差要求严格，需±0.03V</td>
                                            <td class="table-cell">精密零件</td>
                                            <td class="table-cell">2cm×2cm</td>
                                            <td class="table-cell">8000</td>
                                            <td class="table-cell">¥5.65</td>
                                            <td class="table-cell">¥45,200</td>
                                            <td class="table-cell">需要特殊工艺</td>
                                            <td class="table-cell">
                                                <span class="status-badge status-pending">待处理</span>
                                            </td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </td>
                                            <td class="table-cell">ORD-2023-0122</td>
                                            <td class="table-cell">佛山金属制品有限公司</td>
                                            <td class="table-cell">2023-06-13</td>
                                            <td class="table-cell">2023-06-18</td>
                                            <td class="table-cell">按标准工艺执行</td>
                                            <td class="table-cell">金属外壳</td>
                                            <td class="table-cell">15cm×10cm</td>
                                            <td class="table-cell">3000</td>
                                            <td class="table-cell">¥9.27</td>
                                            <td class="table-cell">¥27,800</td>
                                            <td class="table-cell">无</td>
                                            <td class="table-cell">
                                                <span class="status-badge status-completed">已完成</span>
                                            </td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                            </td>
                                            <td class="table-cell">ORD-2023-0121</td>
                                            <td class="table-cell">珠海精密零件有限公司</td>
                                            <td class="table-cell">2023-06-12</td>
                                            <td class="table-cell">2023-06-17</td>
                                            <td class="table-cell">需要调整工艺参数</td>
                                            <td class="table-cell">精密轴承</td>
                                            <td class="table-cell">3cm×3cm</td>
                                            <td class="table-cell">6000</td>
                                            <td class="table-cell">¥2.6</td>
                                            <td class="table-cell">¥15,600</td>
                                            <td class="table-cell">客户取消订单</td>
                                            <td class="table-cell">
                                                <span class="status-badge status-cancelled">已取消</span>
                                            </td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 收发货管理 -->
                <div id="deliveries" class="page-content">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">收发货管理</h3>
                            <div class="flex items-center gap-3">
                                <button id="add-delivery-btn" class="btn-primary flex items-center">
                                    <i class="fa fa-plus mr-2"></i> 新建收发货单
                                </button>
                                <button id="shipmentsDeleteAll" class="btn-danger flex items-center">
                                    <i class="fa fa-trash mr-2"></i> 删除所有记录
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <div class="w-full md:w-auto">
                                    <input type="text" id="deliveries-search-input" placeholder="搜索发货单号、订单编号..." class="form-input">
                                </div>

                                <div class="w-full md:w-auto">
                                    <select id="deliveries-customer-filter" class="form-input">
                                        <option value="">所有客户</option>
                                        <option value="customer1">深圳科技有限公司</option>
                                        <option value="customer2">广州电子有限公司</option>
                                        <option value="customer3">东莞精密制造有限公司</option>
                                        <option value="customer4">佛山金属制品有限公司</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <div class="flex items-center space-x-2">
                                        <input type="date" id="deliveries-start-date" class="form-input" placeholder="开始日期">
                                        <span>至</span>
                                        <input type="date" id="deliveries-end-date" class="form-input" placeholder="结束日期">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto mr-3">
                                    <button id="deliveries-search-btn" class="btn-primary">
                                        <i class="fa fa-search mr-2"></i> 搜索
                                    </button>
                                </div>
                                <div class="w-full md:w-auto">
                                    <button id="deliveries-reset-btn" class="btn-secondary">
                                        <i class="fa fa-refresh mr-2"></i> 重置
                                    </button>
                                </div>

                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="deliveriesTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="table-header w-12">
                                                <input type="checkbox" id="deliveries-select-all">
                                            </th>
                                            <th scope="col" class="table-header">类型</th>
                                            <th scope="col" class="table-header">收发日期</th>
                                            <th scope="col" class="table-header">订单编号</th>
                                            <th scope="col" class="table-header">客户</th>
                                            <th scope="col" class="table-header">产品名称</th>
                                            <th scope="col" class="table-header">毛坯数量</th>
                                            <th scope="col" class="table-header">电镀数量</th>
                                            <th scope="col" class="table-header">返镀数量</th>
                                            <th scope="col" class="table-header">返修数量</th>
                                            <th scope="col" class="table-header">报废数量</th>
                                            <th scope="col" class="table-header">备注</th>
                                            <th scope="col" class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="deliveriesTableBody">
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 送货安排 -->
                <div id="shipping" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">送货安排</h3>
                            <div class="flex space-x-3">
                                <button id="createShipmentBtn" class="btn-primary flex items-center">
                                    <i class="fa fa-plus mr-2"></i> 新建送货安排
                                </button>
                                <button id="deleteAllShipmentsBtn" class="btn-danger flex items-center">
                                    <i class="fa fa-trash mr-2"></i> 删除所有记录
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <div class="w-full md:w-auto">
                                    <input type="text" id="shipments-search-input" placeholder="搜索发货单号、客户名称..." class="form-input">
                                </div>

                                <div class="w-full md:w-auto">
                                    <select id="shipments-driver-filter" class="form-input">
                                        <option value="">所有司机</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <input type="date" id="shipments-start-date" class="form-input" placeholder="开始日期">
                                </div>
                                <div class="w-full md:w-auto">
                                    <input type="date" id="shipments-end-date" class="form-input" placeholder="结束日期">
                                </div>
                                <div class="w-full md:w-auto mr-3">
                                    <button id="shipments-search-btn" class="btn-primary">
                                        <i class="fa fa-search mr-2"></i> 搜索
                                    </button>
                                </div>
                                <div class="w-full md:w-auto">
                                    <button id="shipments-reset-btn" class="btn-secondary">
                                        <i class="fa fa-refresh mr-2"></i> 重置
                                    </button>
                                </div>
                                
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="shipmentsTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="table-header">订单编号</th>
                                            <th scope="col" class="table-header">客户</th>
                                            <th scope="col" class="table-header">路线</th>
                                            <th scope="col" class="table-header">送货日期</th>
                                            <th scope="col" class="table-header">司机</th>
                                            <th scope="col" class="table-header">电话</th>
                                            <th scope="col" class="table-header">车牌</th>
                                            <th scope="col" class="table-header">费用</th>
                                            <th scope="col" class="table-header">备注</th>
                                            <th scope="col" class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="shipmentsTableBody">
                                      </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 开票管理 -->
                <div id="invoices" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">开票收款管理</h3>
                            <div class="flex gap-3">
                                <button id="createInvoiceBtn" class="btn-primary flex items-center">
                                    <i class="fa fa-plus mr-2"></i> 新建发票
                                </button>
                                <button id="invoicesDeleteAll" class="btn-danger flex items-center">
                                    <i class="fa fa-trash mr-2"></i> 删除所有记录
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <div class="w-full md:w-auto">
                                    <input type="text" id="invoices-search-input" placeholder="搜索发票编号、订单编号..." class="form-input">
                                </div>
                                <div class="w-full md:w-auto">
                                    <select id="invoices-status-filter" class="form-input">
                                        <option value="">所有状态</option>
                                        <option value="pending">待付款</option>
                                        <option value="paid">已付款</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <select id="invoices-customer-filter" class="form-input">
                                        <option value="">所有客户</option>
                                        <option value="customer1">深圳科技有限公司</option>
                                        <option value="customer2">广州电子有限公司</option>
                                        <option value="customer3">东莞精密制造有限公司</option>
                                        <option value="customer4">佛山金属制品有限公司</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <div class="flex items-center space-x-2">
                                        <input type="date" id="invoices-start-date" class="form-input" placeholder="开始日期">
                                        <span>至</span>
                                        <input type="date" id="invoices-end-date" class="form-input" placeholder="结束日期">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto mr-3">
                                    <button id="invoices-search-btn" class="btn-primary">
                                        <i class="fa fa-search mr-2"></i> 搜索
                                    </button>
                                </div>
                                <div class="w-full md:w-auto mr-3">
                                    <button id="invoices-reset-btn" class="btn-secondary">
                                        <i class="fa fa-refresh mr-2"></i> 重置
                                    </button>
                                </div>

                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="invoicesTable">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="table-header">付款状态</th>
                                            <th scope="col" class="table-header">付款日期</th>
                                            <th scope="col" class="table-header">订单编号</th>
                                            <th scope="col" class="table-header">客户</th>
                                            <th scope="col" class="table-header">开票日期</th>
                                            <th scope="col" class="table-header">发票号</th>
                                            <th scope="col" class="table-header">金额</th>
                                            <th scope="col" class="table-header">备注</th>
                                            <th scope="col" class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="invoicesTableBody">
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <span class="status-badge status-processing">已开票</span>
                                            </td>
                                            <td class="table-cell"></td>
                                            <td class="table-cell">ORD-2023-0124</td>
                                            <td class="table-cell">广州电子有限公司</td>
                                            <td class="table-cell">2023-06-15</td>
                                            <td class="table-cell">INV-2023-0065</td>
                                            <td class="table-cell">¥18,700</td>
                                            <td class="table-cell">已完成</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-success hover:text-success/80">
                                                    <i class="fa fa-print"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <span class="status-badge status-completed">已付款</span>
                                            </td>
                                            <td class="table-cell">2023-06-15</td>
                                            <td class="table-cell">ORD-2023-0122</td>
                                            <td class="table-cell">佛山金属制品有限公司</td>
                                            <td class="table-cell">2023-06-14</td>
                                            <td class="table-cell">INV-2023-0064</td>
                                            <td class="table-cell">¥27,800</td>
                                            <td class="table-cell">已收款</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-success hover:text-success/80">
                                                    <i class="fa fa-print"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <span class="status-badge status-danger">已逾期</span>
                                            </td>
                                            <td class="table-cell"></td>
                                            <td class="table-cell">ORD-2023-0120</td>
                                            <td class="table-cell">珠海精密零件有限公司</td>
                                            <td class="table-cell">2023-06-10</td>
                                            <td class="table-cell">INV-2023-0063</td>
                                            <td class="table-cell">¥22,500</td>
                                            <td class="table-cell">逾期未付款</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-success hover:text-success/80">
                                                    <i class="fa fa-print"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">
                                                <span class="status-badge status-pending">待开票</span>
                                            </td>
                                            <td class="table-cell"></td>
                                            <td class="table-cell">ORD-2023-0125</td>
                                            <td class="table-cell">深圳科技有限公司</td>
                                            <td class="table-cell">-</td>
                                            <td class="table-cell">-</td>
                                            <td class="table-cell">¥32,500</td>
                                            <td class="table-cell">未处理</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-success hover:text-success/80">
                                                    <i class="fa fa-print"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>



                <!-- 客户管理 -->
                <div id="customers" class="page-content hidden">
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">客户管理</h3>
                            <div class="flex space-x-3">
                                <button class="btn-primary flex items-center">
                                    <i class="fa fa-plus mr-2"></i> 新建客户
                                </button>
                                <button class="btn-danger flex items-center" id="delete-all-customers">
                                    <i class="fa fa-trash mr-2"></i> 删除所有记录
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <div class="w-full md:w-auto">
                                    <input type="text" id="customer-search-input" placeholder="搜索客户信息..." class="form-input">
                                </div>
                                <div class="w-full md:w-auto">
                                    <select id="customer-type-filter" class="form-input">
                                        <option value="">所有客户类型</option>
                                        <option value="制造商">制造商</option>
                                        <option value="贸易商">贸易商</option>
                                        <option value="零售商">零售商</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="table-header">客户</th>
                                            <th scope="col" class="table-header">联系人</th>
                                            <th scope="col" class="table-header">电话</th>
                                            <th scope="col" class="table-header">地址</th>
                                            <th scope="col" class="table-header">客户类型</th>
                                            <th scope="col" class="table-header">税号</th>
                                            <th scope="col" class="table-header">开户行</th>
                                            <th scope="col" class="table-header">账号</th>
                                            <th scope="col" class="table-header">备注</th>
                                            <th scope="col" class="table-header">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr class="table-row">
                                            <td class="table-cell">深圳科技有限公司</td>
                                            <td class="table-cell">陈先生</td>
                                            <td class="table-cell">138-0000-0001</td>
                                            <td class="table-cell">深圳市南山区科技园</td>
                                            <td class="table-cell">制造商</td>
                                            <td class="table-cell">91440300708463866F</td>
                                            <td class="table-cell">招商银行深圳分行</td>
                                            <td class="table-cell">6225887890123456</td>
                                            <td class="table-cell">长期合作客户</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">广州电子有限公司</td>
                                            <td class="table-cell">李女士</td>
                                            <td class="table-cell">139-0000-0002</td>
                                            <td class="table-cell">广州市天河区电子城</td>
                                            <td class="table-cell">制造商</td>
                                            <td class="table-cell">91440101721948359K</td>
                                            <td class="table-cell">工商银行广州分行</td>
                                            <td class="table-cell">6222023602012345678</td>
                                            <td class="table-cell">优质客户，优先处理</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">东莞精密制造有限公司</td>
                                            <td class="table-cell">王先生</td>
                                            <td class="table-cell">137-0000-0003</td>
                                            <td class="table-cell">东莞市长安镇工业区</td>
                                            <td class="table-cell">制造商</td>
                                            <td class="table-cell">91441900618309786L</td>
                                            <td class="table-cell">建设银行东莞分行</td>
                                            <td class="table-cell">6217003210001234567</td>
                                            <td class="table-cell"></td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">佛山金属制品有限公司</td>
                                            <td class="table-cell">赵女士</td>
                                            <td class="table-cell">136-0000-0004</td>
                                            <td class="table-cell">佛山市顺德区金属城</td>
                                            <td class="table-cell">制造商</td>
                                            <td class="table-cell">91440606749173293B</td>
                                            <td class="table-cell">农业银行佛山分行</td>
                                            <td class="table-cell">6228480088881234567</td>
                                            <td class="table-cell">需要提供发票</td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="table-row">
                                            <td class="table-cell">珠海精密零件有限公司</td>
                                            <td class="table-cell">刘先生</td>
                                            <td class="table-cell">135-0000-0005</td>
                                            <td class="table-cell">珠海市香洲区科技园</td>
                                            <td class="table-cell">制造商</td>
                                            <td class="table-cell">91440400727852346W</td>
                                            <td class="table-cell">中国银行珠海分行</td>
                                            <td class="table-cell">6216617000001234567</td>
                                            <td class="table-cell"></td>
                                            <td class="table-cell">
                                                <button class="text-primary hover:text-primary/80 mr-3">
                                                    <i class="fa fa-eye"></i>
                                                </button>
                                                <button class="text-gray-500 hover:text-gray-700 mr-3">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="text-danger hover:text-danger/80">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" style="margin-top: 16px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <span id="customerRecordCount">显示 1 到 10 条，共 0 条记录</span>
                                        <select id="customerPerPage" style="margin-left: 20px; padding: 5px;">
                                            <option value="10">10条/页</option>
                                            <option value="20">20条/页</option>
                                            <option value="50">50条/页</option>
                                            <option value="100">100条/页</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <button id="customerFirstPage" class="btn-default" style="margin-right: 5px; padding: 5px 10px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px;"><i class="fa fa-angle-double-left"></i> 首页</button>
                                        <button id="customerPrevPage" class="btn-default" style="margin-right: 5px; padding: 5px 10px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px;"><i class="fa fa-angle-left"></i> 上一页</button>
                                        <span style="margin: 0 10px;">第 <span id="customerCurrentPage">1</span> / <span id="customerTotalPages">1</span> 页</span>
                                        <button id="customerNextPage" class="btn-default" style="margin-right: 5px; padding: 5px 10px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px;">下一页 <i class="fa fa-angle-right"></i></button>
                                        <button id="customerLastPage" class="btn-default" style="margin-right: 5px; padding: 5px 10px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px;">末页 <i class="fa fa-angle-double-right"></i></button>
                                        <div style="margin-left: 20px; display: flex; align-items: center;">
                                            <span>跳转至</span>
                                            <input type="number" id="customerPageJump" style="width: 50px; margin: 0 5px; padding: 5px;" min="1" value="1">
                                            <button id="customerPageJumpBtn" class="btn-default" style="padding: 5px 10px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px;">确定</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </main>
        </div>
    </div>

    <!-- 新建订单模态框 -->
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" id="add-order-modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">新建订单</h3>
                <button class="text-gray-400 hover:text-gray-500 focus:outline-none" id="close-order-modal">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="order-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="form-group">
                            <label for="order-customer" class="form-label">客户 <span class="text-red-500">*</span></label>
                            <select id="order-customer" class="form-input" required>
                                <option value="">请选择客户</option>
                                <option value="customer1">深圳科技有限公司</option>
                                <option value="customer2">广州电子有限公司</option>
                                <option value="customer3">东莞精密制造有限公司</option>
                                <option value="customer4">佛山金属制品有限公司</option>
                                <option value="customer5">珠海精密零件有限公司</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="order-number" class="form-label">订单号 <span class="text-red-500">*</span></label>
                            <input type="text" id="order-number" class="form-input" placeholder="请输入订单号" required>
                        </div>
                        <div class="form-group">
                            <label for="order-date" class="form-label">订单日期 <span class="text-red-500">*</span></label>
                            <input type="date" id="order-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="due-date" class="form-label">交货日期 <span class="text-red-500">*</span></label>
                            <input type="date" id="due-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="plating-requirements" class="form-label">电位差等电镀技术要求</label>
                            <textarea id="plating-requirements" class="form-input" rows="3" placeholder="请输入电位差等电镀技术要求">≧18/180</textarea>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-md font-medium text-gray-900 mb-3">订单项目</h4>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">产品名称</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">规格</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单价</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="order-items">
                                    <tr>
                                        <td class="px-4 py-3">
                                            <input type="text" class="form-input" placeholder="产品名称">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="text" class="form-input" placeholder="产品规格">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="number" class="form-input item-quantity" placeholder="数量" min="1">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="number" class="form-input item-price" placeholder="单价" step="0.01" min="0">
                                        </td>
                                        <td class="px-4 py-3">
                                            <input type="text" class="form-input bg-gray-50 item-amount" placeholder="金额" readonly>
                                        </td>
                                        <td class="px-4 py-3">
                                            <button type="button" class="text-danger hover:text-danger/80 remove-item">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button type="button" class="btn-secondary flex items-center" id="add-order-item">
                                <i class="fa fa-plus mr-2"></i> 添加项目
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="form-group">
                            <label for="order-notes" class="form-label">备注</label>
                            <textarea id="order-notes" class="form-input" rows="3" placeholder="订单备注信息"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">订单总金额</label>
                            <div class="mt-1 flex items-center">
                                <span class="text-2xl font-semibold text-gray-900">¥</span>
                                <span class="text-2xl font-semibold text-gray-900 ml-1" id="order-total">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" class="btn-secondary mr-3" id="cancel-order">取消</button>
                        <button type="submit" class="btn-primary">保存订单</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 侧边栏导航
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const pageContents = document.querySelectorAll('.page-content');

            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有活动状态
                    sidebarLinks.forEach(item => {
                        item.classList.remove('sidebar-active');
                        item.classList.add('text-white', 'hover:bg-white/10');
                    });
                    
                    // 添加当前活动状态
                    this.classList.add('sidebar-active');
                    this.classList.remove('text-white', 'hover:bg-white/10');
                    
                    // 隐藏所有内容
                    pageContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // 显示目标内容
                    const targetId = this.getAttribute('data-target');
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                    

                    
                    // 关闭移动端菜单
                    document.getElementById('mobile-menu-overlay').classList.add('hidden');
                });
            });
            
            // 移动端菜单按钮
            document.getElementById('mobile-menu-button').addEventListener('click', function() {
                document.getElementById('mobile-menu-overlay').classList.remove('hidden');
            });
            
            // 移动端菜单关闭按钮
            document.getElementById('mobile-menu-close').addEventListener('click', function() {
                document.getElementById('mobile-menu-overlay').classList.add('hidden');
            });
            
            // 通知下拉菜单（添加null检查）
            const notificationButton = document.getElementById('notification-button');
            if (notificationButton) {
                notificationButton.addEventListener('click', function() {
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) {
                        dropdown.classList.toggle('hidden');
                        document.getElementById('user-dropdown').classList.add('hidden');
                    }
                });
            }
            
            // 用户下拉菜单（添加null检查）
            const userMenuButton = document.getElementById('user-menu-button');
            if (userMenuButton) {
                userMenuButton.addEventListener('click', function() {
                    const dropdown = document.getElementById('user-dropdown');
                    if (dropdown) {
                        dropdown.classList.toggle('hidden');
                        // 通知下拉菜单可能不存在，添加null检查
                        const notificationDropdown = document.getElementById('notification-dropdown');
                        if (notificationDropdown) {
                            notificationDropdown.classList.add('hidden');
                        }
                    }
                });
            }
            
            // 点击其他地方关闭下拉菜单（添加null检查）
            document.addEventListener('click', function(e) {
                // 通知下拉菜单可能不存在，添加null检查
                const notificationDropdown = document.getElementById('notification-dropdown');
                if (notificationDropdown && !e.target.closest('#notification-button') && !e.target.closest('#notification-dropdown')) {
                    notificationDropdown.classList.add('hidden');
                }
                
                const userDropdown = document.getElementById('user-dropdown');
                if (userDropdown && !e.target.closest('#user-menu-button') && !e.target.closest('#user-dropdown')) {
                    userDropdown.classList.add('hidden');
                }
            });
            
            // 新建订单模态框
            const addOrderBtn = document.getElementById('add-order-btn');
            const addOrderModal = document.getElementById('add-order-modal');
            const closeOrderModal = document.getElementById('close-order-modal');
            const cancelOrder = document.getElementById('cancel-order');
            
            // 加载客户数据到下拉框
            function loadCustomersToDropdown() {
                const customerSelect = document.getElementById('order-customer');
                if (!customerSelect) return;
                
                // 清空现有选项
                customerSelect.innerHTML = '<option value="">请选择客户</option>';
                
                // 从localStorage获取客户数据
                const savedCustomers = localStorage.getItem('customers');
                if (savedCustomers) {
                    const customers = JSON.parse(savedCustomers);
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        customerSelect.appendChild(option);
                    });
                } else {
                    // 如果没有保存的数据，从HTML表格中提取初始数据
                    const tableRows = document.querySelectorAll('#customers .table-row');
                    Array.from(tableRows).forEach(row => {
                        const cells = row.querySelectorAll('.table-cell');
                        const customerName = cells[0].textContent.trim();
                        if (customerName) {
                            const option = document.createElement('option');
                            option.value = customerName;
                            option.textContent = customerName;
                            customerSelect.appendChild(option);
                        }
                    });
                }
            }
            
            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', function() {
                    addOrderModal.classList.remove('hidden');
                    // 打开模态框时加载客户数据
                    loadCustomersToDropdown();
                    
                    // 为模态框中的产品名称输入框添加自动完成功能
                    setTimeout(() => {
                        const productInputs = document.querySelectorAll('#order-items input[placeholder="产品名称"]');
                        productInputs.forEach(input => {
                            // 检查输入框是否已经有自动完成功能
                            if (!input.hasAttribute('data-autocomplete-initialized')) {
                                addProductNameAutoComplete(input);
                                input.setAttribute('data-autocomplete-initialized', 'true');
                            }
                        });
                    }, 100);
                });
            }
            
            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', function() {
                    addOrderModal.classList.add('hidden');
                });
            }
            
            if (cancelOrder) {
                cancelOrder.addEventListener('click', function() {
                    addOrderModal.classList.add('hidden');
                });
            }
            
            // 点击模态框外部关闭
            addOrderModal.addEventListener('click', function(e) {
                if (e.target === addOrderModal) {
                    addOrderModal.classList.add('hidden');
                }
            });
            
            // 设置订单日期默认为今日
            const orderDateInput = document.getElementById('order-date');
            if (orderDateInput) {
                const today = new Date().toISOString().split('T')[0];
                orderDateInput.value = today;
            }
            
            // 产品名称自动完成功能
            function getProductNames() {
                const productNames = new Set();
                
                // 从订单表格中提取产品名称
                const ordersTableBody = document.getElementById('ordersTableBody');
                if (ordersTableBody) {
                    const rows = ordersTableBody.querySelectorAll('.table-row');
                    rows.forEach(row => {
                        // 第7列是产品名称（索引从0开始）
                        const productNameCell = row.querySelectorAll('.table-cell')[6];
                        if (productNameCell && productNameCell.textContent.trim() !== '-') {
                            productNames.add(productNameCell.textContent.trim());
                        }
                    });
                }
                
                // 从localStorage中的订单数据提取产品名称
                const ordersData = localStorage.getItem('ordersData');
                if (ordersData) {
                    try {
                        const parsedOrders = JSON.parse(ordersData);
                        parsedOrders.forEach(order => {
                            // 第6列是产品名称（索引从0开始）
                            if (order.cells && order.cells.length > 6 && order.cells[6].trim() !== '-') {
                                productNames.add(order.cells[6].trim());
                            }
                        });
                    } catch (e) {
                        console.error('解析订单数据失败:', e);
                    }
                }
                
                // 从localStorage中的完整订单数据提取产品名称
                const orders = localStorage.getItem('orders');
                if (orders) {
                    try {
                        const parsedOrders = JSON.parse(orders);
                        if (Array.isArray(parsedOrders)) {
                            parsedOrders.forEach(order => {
                                if (order.items && Array.isArray(order.items)) {
                                    order.items.forEach(item => {
                                        if (item.productName && item.productName.trim()) {
                                            productNames.add(item.productName.trim());
                                        }
                                    });
                                }
                            });
                        } else if (parsedOrders.items && Array.isArray(parsedOrders.items)) {
                            parsedOrders.items.forEach(item => {
                                if (item.productName && item.productName.trim()) {
                                    productNames.add(item.productName.trim());
                                }
                            });
                        }
                    } catch (e) {
                        console.error('解析完整订单数据失败:', e);
                    }
                }
                
                return Array.from(productNames).sort();
            }
            
            // 为产品名称输入框添加自动完成功能
            function addProductNameAutoComplete(inputElement) {
                if (!inputElement) return;
                
                // 创建下拉列表容器
                const dropdown = document.createElement('div');
                dropdown.className = 'autocomplete-dropdown';
                dropdown.style.position = 'absolute';
                dropdown.style.backgroundColor = 'white';
                dropdown.style.border = '1px solid #ddd';
                dropdown.style.borderRadius = '4px';
                dropdown.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                dropdown.style.maxHeight = '200px';
                dropdown.style.overflowY = 'auto';
                dropdown.style.zIndex = '9999'; // 设置更高的z-index确保显示在最上层
                dropdown.style.display = 'none';
                dropdown.style.width = inputElement.offsetWidth + 'px';
                
                // 添加到body元素中，避免受到父容器overflow属性的影响
                document.body.appendChild(dropdown);
                
                // 计算并设置下拉列表的位置
                const updateDropdownPosition = () => {
                    const rect = inputElement.getBoundingClientRect();
                    dropdown.style.left = rect.left + window.scrollX + 'px';
                    dropdown.style.top = rect.bottom + window.scrollY + 'px';
                };
                
                // 初始化位置
                updateDropdownPosition();
                
                // 监听窗口大小变化和滚动事件，更新下拉列表位置
                window.addEventListener('resize', updateDropdownPosition);
                window.addEventListener('scroll', updateDropdownPosition);
                
                // 输入事件处理
                const inputHandler = function() {
                    const searchTerm = inputElement.value.toLowerCase();
                    const productNames = getProductNames();
                    const filteredNames = productNames.filter(name => name.toLowerCase().includes(searchTerm));
                    
                    // 显示或隐藏下拉列表
                    if (filteredNames.length > 0 && searchTerm.length > 0) {
                        dropdown.innerHTML = '';
                        filteredNames.forEach(name => {
                            const option = document.createElement('div');
                            option.className = 'autocomplete-option';
                            option.style.padding = '8px 12px';
                            option.style.cursor = 'pointer';
                            option.style.color = '#333';
                            option.style.fontSize = '14px';
                            option.textContent = name;
                            
                            // 鼠标悬停效果
                            option.addEventListener('mouseenter', function() {
                                this.style.backgroundColor = '#f0f0f0';
                            });
                            
                            option.addEventListener('mouseleave', function() {
                                this.style.backgroundColor = 'white';
                            });
                            
                            // 点击选择
                            option.addEventListener('click', function() {
                                inputElement.value = name;
                                dropdown.style.display = 'none';
                            });
                            
                            dropdown.appendChild(option);
                        });
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                };
                inputElement.addEventListener('input', inputHandler);
                
                // 点击外部关闭下拉列表
                const clickOutsideHandler = function(e) {
                    if (e.target !== inputElement && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                };
                document.addEventListener('click', clickOutsideHandler);
                
                // 移除事件监听和下拉列表
                return function cleanup() {
                    inputElement.removeEventListener('input', inputHandler);
                    document.removeEventListener('click', clickOutsideHandler);
                    window.removeEventListener('resize', updateDropdownPosition);
                    window.removeEventListener('scroll', updateDropdownPosition);
                    if (dropdown.parentElement) {
                        dropdown.parentElement.removeChild(dropdown);
                    }
                };
            }
            
            // 添加订单项目
            const addOrderItemBtn = document.getElementById('add-order-item');
            const orderItemsTable = document.getElementById('order-items');
            
            if (addOrderItemBtn && orderItemsTable) {
                addOrderItemBtn.addEventListener('click', function() {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-4 py-3">
                            <input type="text" class="form-input" placeholder="产品名称">
                        </td>
                        <td class="px-4 py-3">
                            <input type="text" class="form-input" placeholder="产品规格">
                        </td>
                        <td class="px-4 py-3">
                            <input type="number" class="form-input item-quantity" placeholder="数量" min="1">
                        </td>
                        <td class="px-4 py-3">
                            <input type="number" class="form-input item-price" placeholder="单价" step="0.01" min="0">
                        </td>
                        <td class="px-4 py-3">
                            <input type="text" class="form-input bg-gray-50 item-amount" placeholder="金额" readonly>
                        </td>
                        <td class="px-4 py-3">
                            <button type="button" class="text-danger hover:text-danger/80 remove-item">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    `;
                    orderItemsTable.appendChild(newRow);
                    
                    // 添加事件监听器
                    const quantityInput = newRow.querySelector('.item-quantity');
                    const priceInput = newRow.querySelector('.item-price');
                    const amountInput = newRow.querySelector('.item-amount');
                    const removeBtn = newRow.querySelector('.remove-item');
                    // 为新添加的产品名称输入框添加自动完成功能
                    const productInput = newRow.querySelector('input[placeholder="产品名称"]');
                    addProductNameAutoComplete(productInput);
                    
                    function updateAmount() {
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const price = parseFloat(priceInput.value) || 0;
                        const amount = quantity * price;
                        amountInput.value = formatNumber(amount, 2);
                        updateTotal();
                    }
                    
                    quantityInput.addEventListener('input', updateAmount);
                    priceInput.addEventListener('input', updateAmount);
                    
                    removeBtn.addEventListener('click', function() {
                        newRow.remove();
                        updateTotal();
                    });
                });
            }
            
            // 检查订单编号是否存在的函数
            function isOrderNumberExists(orderNumber, excludeIndex = -1) {
                // 获取订单数据
                const ordersData = JSON.parse(localStorage.getItem('ordersData') || '[]');
                
                // 检查每个订单的订单编号
                for (let i = 0; i < ordersData.length; i++) {
                    // 跳过排除的索引（用于编辑场景）
                    if (i === excludeIndex) continue;
                    
                    const order = ordersData[i];
                    const cells = order.cells || [];
                    if (cells.length > 4 && cells[4] === orderNumber) {
                        return true; // 找到重复的订单编号
                    }
                }
                return false; // 没有找到重复的订单编号
            }

            // 订单表单提交
            const orderForm = document.getElementById('order-form');
            if (orderForm) {
                orderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 检查订单编号是否存在
                    const orderNumber = document.getElementById('order-number').value;
                    if (isOrderNumberExists(orderNumber)) {
                        alert('订单编号已存在，请使用不同的订单编号！');
                        return; // 阻止表单提交
                    }
                    
                    // 获取表单数据
                    const orderData = {
                        orderNumber: orderNumber,
                        customer: document.getElementById('order-customer').value,
                        orderDate: document.getElementById('order-date').value,
                        dueDate: document.getElementById('due-date').value,
                        platingRequirements: document.getElementById('plating-requirements').value,
                        notes: document.getElementById('order-notes').value,
                        totalAmount: document.getElementById('order-total').textContent,
                        items: [],
                        status: '未完成'
                    };
                    
                    // 获取订单项目
                    const orderItems = document.querySelectorAll('#order-items tr');
                    orderItems.forEach((row, index) => {
                        const productName = row.querySelector('input[placeholder="产品名称"]').value;
                        const specification = row.querySelector('input[placeholder="产品规格"]').value;
                        const quantity = row.querySelector('input[type="number"][placeholder="数量"]').value;
                        const price = row.querySelector('input[type="number"][placeholder="单价"]').value;
                        const amount = row.querySelector('.item-amount').value;
                        
                        if (productName || specification || quantity || price) {
                            orderData.items.push({
                                id: index + 1,
                                productName: productName,
                                specification: specification,
                                quantity: quantity,
                                price: price,
                                amount: amount
                            });
                        }
                    });
                    
                    // 根据客户ID获取客户名称的函数
                    function getCustomerNameById(customerId) {
                        // 从localStorage获取客户数据
                        const savedCustomers = localStorage.getItem('customers');
                        if (savedCustomers) {
                            const customers = JSON.parse(savedCustomers);
                            const customer = customers.find(c => c.id.toString() === customerId.toString());
                            return customer ? customer.name : customerId;
                        }
                        return customerId;
                    }
                    
                    // 添加到表格中显示
                    const ordersTableBody = document.getElementById('ordersTableBody');
                    const newRow = document.createElement('tr');
                    newRow.className = 'table-row';
                    
                    // 使用第一个订单项目的数据填充表格（如果有多个项目，可以选择显示第一个或合并显示）
                    const firstItem = orderData.items[0] || {};
                    
                    // 获取客户名称
                    const customerName = getCustomerNameById(orderData.customer);
                    
                    newRow.innerHTML = `
                        <td class="table-cell">
                            <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                        </td>
                        <td class="table-cell">
                            <span class="status-badge status-pending">${orderData.status}</span>
                        </td>
                        <td class="table-cell">-</td>
                        <td class="table-cell">-</td>
                        <td class="table-cell">-</td>
                        <td class="table-cell">${orderData.orderNumber}</td>
                        <td class="table-cell">${customerName}</td>
                        <td class="table-cell">${orderData.orderDate}</td>
                        <td class="table-cell">${orderData.dueDate}</td>
                        <td class="table-cell">${orderData.platingRequirements}</td>
                        <td class="table-cell">${firstItem.productName || '-'}</td>
                        <td class="table-cell">${firstItem.specification || '-'}</td>
                        <td class="table-cell">${firstItem.quantity || '-'}</td>
                        <td class="table-cell">¥${firstItem.price || '0.00'}</td>
                        <td class="table-cell">¥${orderData.totalAmount}</td>
                        <td class="table-cell">${orderData.notes}</td>
                        <td class="table-cell">
                            <button class="text-gray-500 hover:text-gray-700 mr-3">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="text-danger hover:text-danger/80">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    ordersTableBody.appendChild(newRow);
                    
                    // 保存到localStorage，使用与loadTableData函数兼容的格式
                    // 获取当前表格数据（包括新添加的行）
                    const tableRows = ordersTableBody.querySelectorAll('.table-row');
                    const ordersData = Array.from(tableRows).map(row => {
                        const cells = row.querySelectorAll('.table-cell');
                        // 只保存从第2个到倒数第1个单元格的数据（排除复选框和操作按钮）
                        const cellData = Array.from(cells)
                            .slice(1, -1) // 跳过第一个复选框单元格和最后一个操作按钮单元格
                            .map(cell => cell.textContent.trim());
                        return {
                            cells: cellData
                        };
                    });
                    
                    localStorage.setItem('ordersData', JSON.stringify(ordersData));
                    
                    // 同时保留原始订单数据格式，以便将来需要
                    let orders = JSON.parse(localStorage.getItem('orders')) || [];
                    orders.push(orderData);
                    localStorage.setItem('orders', JSON.stringify(orders));
                    
                    // 更新tableConfigs中的数据，以便搜索和分页功能正常工作
                    tableConfigs.orders.originalData = ordersData;
                    tableConfigs.orders.data = [...ordersData];
                    
                    // 清空表单
                    orderForm.reset();
                    
                    // 重置订单总金额
                    document.getElementById('order-total').textContent = '0.00';
                    
                    // 关闭模态框
                    addOrderModal.classList.add('hidden');
                    
                    alert('订单已保存！');
                });
            }
            
            // 为初始订单项目行添加事件监听器
            function initOrderItemsEvents() {
                const orderItems = document.querySelectorAll('#order-items tr');
                
                orderItems.forEach(row => {
                    const quantityInput = row.querySelector('input[type="number"][placeholder="数量"]');
                    const priceInput = row.querySelector('input[type="number"][placeholder="单价"]');
                    const amountInput = row.querySelector('.item-amount');
                    const removeBtn = row.querySelector('.text-danger');
                    
                    if (quantityInput && priceInput && amountInput) {
                        function updateAmount() {
                            const quantity = parseFloat(quantityInput.value) || 0;
                            const price = parseFloat(priceInput.value) || 0;
                            const amount = quantity * price;
                            amountInput.value = formatNumber(amount, 2);
                            updateTotal();
                        }
                        
                        quantityInput.addEventListener('input', updateAmount);
                        priceInput.addEventListener('input', updateAmount);
                    }
                    
                    if (removeBtn) {
                        removeBtn.addEventListener('click', function() {
                            row.remove();
                            updateTotal();
                        });
                    }
                });
            }
            
            // 初始化订单项目事件
            initOrderItemsEvents();
            
            // 更新订单总金额
            function updateTotal() {
                const amountInputs = document.querySelectorAll('.item-amount');
                let total = 0;
                
                amountInputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                
                const orderTotal = document.getElementById('order-total');
                if (orderTotal) {
                    orderTotal.textContent = formatNumber(total, 2);
                }
            }
        });
        
        // 初始化图表
        function initCharts() {
            // 月度订单趋势图
            const orderCtx = document.getElementById('orderChart');
            if (orderCtx) {
                new Chart(orderCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '订单数量',
                            data: [65, 78, 52, 91, 43, 106],
                            borderColor: '#1a56db',
                            backgroundColor: 'rgba(26, 86, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // 收入分析图
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '收入（万元）',
                            data: [12, 19, 15, 25, 22, 30],
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // 新建客户模态框功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框元素
            const customerModal = document.getElementById('add-customer-modal');
            const openCustomerModalBtn = document.querySelector('#customers h3 + div .btn-primary'); // 匹配"客户管理"标题旁边div中的按钮
            const closeCustomerModalBtn = document.getElementById('close-customer-modal');
            const cancelCustomerBtn = document.getElementById('cancel-customer-btn');
            const customerForm = customerModal ? customerModal.querySelector('form') : null;

            // 检查必要元素是否存在
            if (!customerModal || !customerForm) {
                console.error('客户模态框或表单元素未找到');
                return;
            }

            // 打开模态框
            if (openCustomerModalBtn) {
                openCustomerModalBtn.addEventListener('click', function() {
                    customerModal.classList.remove('hidden');
                    // 添加防滚动效果
                    document.body.style.overflow = 'hidden';
                });
            }

            // 关闭模态框
            function closeCustomerModal() {
                customerModal.classList.add('hidden');
                customerForm.reset();
                // 恢复页面滚动
                document.body.style.overflow = 'auto';
            }

            // 点击关闭按钮关闭模态框
            if (closeCustomerModalBtn) {
                closeCustomerModalBtn.addEventListener('click', closeCustomerModal);
            }
            if (cancelCustomerBtn) {
                cancelCustomerBtn.addEventListener('click', closeCustomerModal);
            }

            // 点击模态框外部关闭模态框
            customerModal.addEventListener('click', function(e) {
                // 检查点击的是否是遮罩层
                if (e.target.classList.contains('bg-gray-600')) {
                    closeCustomerModal();
                }
            });

            // 表单提交处理
            customerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 从表单获取数据
                const name = document.getElementById('customer-name').value.trim();
                const contact = document.getElementById('contact-person').value.trim();
                const phone = document.getElementById('phone-number').value.trim();
                const address = document.getElementById('address').value.trim();
                const type = document.getElementById('customer-type').value;
                const taxId = document.getElementById('tax-number').value.trim();
                const bank = document.getElementById('bank-name').value.trim();
                const account = document.getElementById('bank-account').value.trim();
                const notes = document.getElementById('remarks').value.trim();
                
                // 创建新客户对象
                const newCustomer = {
                    id: Date.now() + Math.random(), // 生成唯一ID
                    name: name,
                    contact: contact,
                    phone: phone,
                    address: address,
                    type: type,
                    taxId: taxId,
                    bank: bank,
                    account: account,
                    notes: notes
                };
                
                // 添加到客户数组
                customers.push(newCustomer);
                
                // 保存到localStorage
                localStorage.setItem('customers', JSON.stringify(customers));
                
                // 重新渲染表格
                renderCustomersWithFilters();
                
                // 关闭模态框
                alert('客户添加成功！');
                closeCustomerModal();
            });
        });

        // 客户数据持久化管理
        let customers = [];
        const customersTableBody = document.querySelector('#customers tbody');
        
        // 客户管理分页变量
        let currentCustomerPage = 1;
        let customerPerPage = 10;
        let totalCustomerPages = 1;
        
        // 初始化客户数据
        function initCustomers() {
            // 从localStorage加载数据
            const savedCustomers = localStorage.getItem('customers');
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            } else {
                // 如果没有保存的数据，从HTML表格中提取初始数据
                const tableRows = document.querySelectorAll('#customers .table-row');
                customers = Array.from(tableRows).map(row => {
                    const cells = row.querySelectorAll('.table-cell');
                    return {
                        id: Date.now() + Math.random(), // 生成唯一ID
                        name: cells[0].textContent.trim(),
                        contact: cells[1].textContent.trim(),
                        phone: cells[2].textContent.trim(),
                        address: cells[3].textContent.trim(),
                        type: cells[4].textContent.trim(),
                        taxId: cells[5].textContent.trim(),
                        bank: cells[6].textContent.trim(),
                        account: cells[7].textContent.trim(),
                        notes: cells[8].textContent.trim()
                    };
                });
                // 保存初始数据到localStorage
                localStorage.setItem('customers', JSON.stringify(customers));
            }
            // 更新客户类型下拉框选项
            updateCustomerTypeOptions();
            // 重新渲染表格
            renderCustomersWithFilters();
        }
        
        // 渲染客户表格
        function renderCustomers(searchKeyword = '') {
            if (!customersTableBody) return;
            
            // 过滤客户数据
            let filteredCustomers = [...customers];
            if (searchKeyword.trim()) {
                const keyword = searchKeyword.toLowerCase().trim();
                filteredCustomers = customers.filter(customer => {
                    return (
                        (customer.name && customer.name.toLowerCase().includes(keyword)) ||
                        (customer.contact && customer.contact.toLowerCase().includes(keyword)) ||
                        (customer.phone && customer.phone.toLowerCase().includes(keyword)) ||
                        (customer.address && customer.address.toLowerCase().includes(keyword)) ||
                        (customer.type && customer.type.toLowerCase().includes(keyword)) ||
                        (customer.taxId && customer.taxId.toLowerCase().includes(keyword)) ||
                        (customer.bank && customer.bank.toLowerCase().includes(keyword)) ||
                        (customer.notes && customer.notes.toLowerCase().includes(keyword))
                    );
                });
            }
            
            // 计算总页数
            totalCustomerPages = Math.ceil(filteredCustomers.length / customerPerPage);
            // 确保当前页码不超过总页数
            if (currentCustomerPage > totalCustomerPages) {
                currentCustomerPage = totalCustomerPages || 1;
            }
            
            // 计算当前页的数据范围
            const startIndex = (currentCustomerPage - 1) * customerPerPage;
            const endIndex = startIndex + customerPerPage;
            const currentPageData = filteredCustomers.slice(startIndex, endIndex);
            
            // 更新分页控件
            updateCustomerPaginationControls(filteredCustomers.length);
            
            // 清空表格
            customersTableBody.innerHTML = '';
            
            // 渲染当前页的客户
            currentPageData.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="table-cell">${customer.name}</td>
                    <td class="table-cell">${customer.contact}</td>
                    <td class="table-cell">${customer.phone}</td>
                    <td class="table-cell">${customer.address}</td>
                    <td class="table-cell">${customer.type}</td>
                    <td class="table-cell">${customer.taxId}</td>
                    <td class="table-cell">${customer.bank}</td>
                    <td class="table-cell">${customer.account}</td>
                    <td class="table-cell">${customer.notes}</td>
                    <td class="table-cell">
                        <button class="text-primary hover:text-primary/80 mr-3 view-button">
                            <i class="fa fa-eye"></i>
                        </button>
                        <button class="text-gray-500 hover:text-gray-700 mr-3 edit-button">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-danger/80 delete-button">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;
                customersTableBody.appendChild(row);
            });
            
            // 重新绑定删除事件
            bindDeleteEvents();
            // 绑定查看和编辑事件
            bindViewEditEvents();
            // 绑定查看和编辑事件
            bindViewEditEvents();
            // 绑定查看和编辑事件
            bindViewEditEvents();
        }
        
        // 更新客户分页控件
        function updateCustomerPaginationControls(totalItems) {
            // 更新记录统计信息
            const recordCountEl = document.getElementById('customerRecordCount');
            const startIndex = (currentCustomerPage - 1) * customerPerPage + 1;
            const endIndex = Math.min(currentCustomerPage * customerPerPage, totalItems);
            recordCountEl.textContent = `显示 ${startIndex} 到 ${endIndex} 条，共 ${totalItems} 条记录`;
            
            // 更新页码信息
            const currentPageEl = document.getElementById('customerCurrentPage');
            const totalPagesEl = document.getElementById('customerTotalPages');
            const pageJumpEl = document.getElementById('customerPageJump');
            
            currentPageEl.textContent = currentCustomerPage;
            totalPagesEl.textContent = totalCustomerPages;
            pageJumpEl.value = currentCustomerPage;
            
            // 更新按钮状态
            const firstPageBtn = document.getElementById('customerFirstPage');
            const prevPageBtn = document.getElementById('customerPrevPage');
            const nextPageBtn = document.getElementById('customerNextPage');
            const lastPageBtn = document.getElementById('customerLastPage');
            
            firstPageBtn.disabled = currentCustomerPage === 1;
            prevPageBtn.disabled = currentCustomerPage === 1;
            nextPageBtn.disabled = currentCustomerPage === totalCustomerPages;
            lastPageBtn.disabled = currentCustomerPage === totalCustomerPages;
        }
        
        // 绑定客户分页按钮事件
        function bindCustomerPaginationEvents() {
            document.getElementById('customerFirstPage').addEventListener('click', () => {
                currentCustomerPage = 1;
                renderCustomersWithFilters();
            });
            
            document.getElementById('customerPrevPage').addEventListener('click', () => {
                if (currentCustomerPage > 1) {
                    currentCustomerPage--;
                    renderCustomersWithFilters();
                }
            });
            
            document.getElementById('customerNextPage').addEventListener('click', () => {
                if (currentCustomerPage < totalCustomerPages) {
                    currentCustomerPage++;
                    renderCustomersWithFilters();
                }
            });
            
            document.getElementById('customerLastPage').addEventListener('click', () => {
                currentCustomerPage = totalCustomerPages;
                renderCustomersWithFilters();
            });
            
            // 每页记录数选择
            document.getElementById('customerPerPage').addEventListener('change', (e) => {
                customerPerPage = parseInt(e.target.value);
                currentCustomerPage = 1; // 重置为第一页
                renderCustomersWithFilters();
            });
            
            // 页码跳转
            document.getElementById('customerPageJumpBtn').addEventListener('click', () => {
                const jumpPage = parseInt(document.getElementById('customerPageJump').value);
                if (jumpPage >= 1 && jumpPage <= totalCustomerPages) {
                    currentCustomerPage = jumpPage;
                    renderCustomersWithFilters();
                }
            });
            
            // 页码输入框回车事件
            document.getElementById('customerPageJump').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const jumpPage = parseInt(document.getElementById('customerPageJump').value);
                    if (jumpPage >= 1 && jumpPage <= totalCustomerPages) {
                        currentCustomerPage = jumpPage;
                        renderCustomersWithFilters();
                    }
                }
            });
        }
        
        // 绑定客户搜索和筛选事件
        // 动态更新客户类型下拉框选项
        function updateCustomerTypeOptions() {
            const typeFilter = document.getElementById('customer-type-filter');
            if (!typeFilter) return;
            
            // 从客户数据中提取所有唯一的客户类型值
            const customerTypes = [...new Set(customers.map(customer => customer.type))];
            
            // 保存当前选中的值
            const currentValue = typeFilter.value;
            
            // 清空现有的选项（保留"所有客户类型"）
            typeFilter.innerHTML = '<option value="">所有客户类型</option>';
            
            // 添加唯一的客户类型选项
            customerTypes.forEach(type => {
                if (type && type.trim()) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeFilter.appendChild(option);
                }
            });
            
            // 恢复之前的选中值（如果存在）
            if (currentValue === "" || customerTypes.includes(currentValue)) {
                typeFilter.value = currentValue;
            }
        }
        
        function bindCustomerSearchEvents() {
            const searchInput = document.getElementById('customer-search-input');
            const typeFilter = document.getElementById('customer-type-filter');
            
            // 搜索输入框输入事件 - 实时搜索
            searchInput.addEventListener('input', renderCustomersWithFilters);
            
            // 搜索输入框回车事件 - 确保兼容性
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    renderCustomersWithFilters();
                }
            });
            
            // 客户类型筛选变化事件
            typeFilter.addEventListener('change', renderCustomersWithFilters);
        }
        
        // 应用搜索和筛选条件并渲染客户表格
        function renderCustomersWithFilters() {
            const searchInput = document.getElementById('customer-search-input');
            const typeFilter = document.getElementById('customer-type-filter');
            
            const searchKeyword = searchInput.value.trim();
            const selectedType = typeFilter.value;
            
            // 过滤客户数据
            let filteredCustomers = [...customers];
            
            // 应用类型筛选
            if (selectedType) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.type.toLowerCase() === selectedType.toLowerCase()
                );
            }
            
            // 应用关键词搜索 - 搜索所有字段
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                filteredCustomers = filteredCustomers.filter(customer => {
                    return (
                        (customer.name && customer.name.toLowerCase().includes(keyword)) ||
                        (customer.contact && customer.contact.toLowerCase().includes(keyword)) ||
                        (customer.phone && customer.phone.toLowerCase().includes(keyword)) ||
                        (customer.address && customer.address.toLowerCase().includes(keyword)) ||
                        (customer.type && customer.type.toLowerCase().includes(keyword)) ||
                        (customer.taxId && customer.taxId.toLowerCase().includes(keyword)) ||
                        (customer.bank && customer.bank.toLowerCase().includes(keyword)) ||
                        (customer.account && customer.account.toLowerCase().includes(keyword)) ||
                        (customer.notes && customer.notes.toLowerCase().includes(keyword))
                    );
                });
            }
            
            // 重置当前页码为第一页
            currentCustomerPage = 1;
            
            // 调用渲染函数
            renderCustomersFromFiltered(filteredCustomers);
            
            // 更新客户类型下拉框选项
            updateCustomerTypeOptions();
        }
        
        // 根据过滤后的数据渲染客户表格
        function renderCustomersFromFiltered(filteredCustomers) {
            if (!customersTableBody) return;
            
            // 计算总页数
            totalCustomerPages = Math.ceil(filteredCustomers.length / customerPerPage);
            // 确保当前页码不超过总页数
            if (currentCustomerPage > totalCustomerPages) {
                currentCustomerPage = totalCustomerPages || 1;
            }
            
            // 计算当前页的数据范围
            const startIndex = (currentCustomerPage - 1) * customerPerPage;
            const endIndex = startIndex + customerPerPage;
            const currentPageData = filteredCustomers.slice(startIndex, endIndex);
            
            // 更新分页控件
            updateCustomerPaginationControls(filteredCustomers.length);
            
            // 清空表格
            customersTableBody.innerHTML = '';
            
            // 渲染当前页的客户
            currentPageData.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="table-cell">${customer.name}</td>
                    <td class="table-cell">${customer.contact}</td>
                    <td class="table-cell">${customer.phone}</td>
                    <td class="table-cell">${customer.address}</td>
                    <td class="table-cell">${customer.type}</td>
                    <td class="table-cell">${customer.taxId}</td>
                    <td class="table-cell">${customer.bank}</td>
                    <td class="table-cell">${customer.account}</td>
                    <td class="table-cell">${customer.notes}</td>
                    <td class="table-cell">
                        <button class="text-primary hover:text-primary/80 mr-3 view-button">
                            <i class="fa fa-eye"></i>
                        </button>
                        <button class="text-gray-500 hover:text-gray-700 mr-3 edit-button">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="text-danger hover:text-danger/80 delete-button">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;
                customersTableBody.appendChild(row);
            });
            
            // 重新绑定删除事件
            bindDeleteEvents();
            // 绑定查看和编辑事件
            bindViewEditEvents();
        }
        
        // 绑定删除事件
        function bindDeleteEvents() {
            const deleteButtons = document.querySelectorAll('#customers .table-cell .delete-button');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 确认删除
                    if (confirm('确定要永久性删除这条客户记录吗？此操作不可恢复。')) {
                        // 获取当前行索引
                        const row = this.closest('.table-row');
                        const rowIndex = Array.from(customersTableBody.children).indexOf(row);
                        
                        // 删除数据
                        if (rowIndex !== -1) {
                            customers.splice(rowIndex, 1);
                            // 保存到localStorage
                            localStorage.setItem('customers', JSON.stringify(customers));
                            // 重新渲染表格
                            renderCustomers();
                            alert('客户记录已被永久性删除！');
                        }
                    }
                });
            });
        }
        
        // 绑定查看和编辑事件
        function bindViewEditEvents() {
            // 绑定查看按钮事件
            const viewButtons = document.querySelectorAll('#customers .table-cell .view-button');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行索引
                    const row = this.closest('.table-row');
                    const rowIndex = Array.from(customersTableBody.children).indexOf(row);
                    
                    if (rowIndex !== -1) {
                        const customer = customers[rowIndex];
                        // 显示客户详情（这里可以实现为模态框或弹出窗口）
                        alert(
                            `客户名称：${customer.name}\n` +
                            `联系人：${customer.contact}\n` +
                            `电话：${customer.phone}\n` +
                            `地址：${customer.address}\n` +
                            `客户类型：${customer.type}\n` +
                            `税号：${customer.taxId}\n` +
                            `开户行：${customer.bank}\n` +
                            `账号：${customer.account}\n` +
                            `备注：${customer.notes}`
                        );
                    }
                });
            });
            
            // 绑定编辑按钮事件
            const editButtons = document.querySelectorAll('#customers .table-cell .edit-button');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('.table-row');
                    const cells = row.querySelectorAll('.table-cell');
                    const isEditing = row.dataset.editing === 'true';
                    
                    if (isEditing) {
                        // 保存编辑
                        const rowIndex = Array.from(customersTableBody.children).indexOf(row);
                        if (rowIndex !== -1) {
                            // 更新数据
                            customers[rowIndex] = {
                                ...customers[rowIndex],
                                name: cells[0].querySelector('input').value.trim(),
                                contact: cells[1].querySelector('input').value.trim(),
                                phone: cells[2].querySelector('input').value.trim(),
                                address: cells[3].querySelector('input').value.trim(),
                                type: cells[4].querySelector('input').value.trim(),
                                taxId: cells[5].querySelector('input').value.trim(),
                                bank: cells[6].querySelector('input').value.trim(),
                                account: cells[7].querySelector('input').value.trim(),
                                notes: cells[8].querySelector('input').value.trim()
                            };
                            
                            // 保存到localStorage
                            localStorage.setItem('customers', JSON.stringify(customers));
                            
                            // 更新表格显示
                            for (let i = 0; i < 9; i++) {
                                const input = cells[i].querySelector('input');
                                cells[i].textContent = input.value;
                            }
                            
                            // 恢复编辑图标
                            this.innerHTML = '<i class="fa fa-edit"></i>';
                            row.dataset.editing = 'false';
                            
                            // 更新客户类型下拉框选项
                            updateCustomerTypeOptions();
                            
                            alert('客户信息已更新！');
                        }
                    } else {
                        // 进入编辑模式
                            for (let i = 0; i < 9; i++) {
                                const value = cells[i].textContent.trim();
                                cells[i].innerHTML = `<input type="text" value="${value}" class="form-input w-full min-w-[200px]" />`;
                            }
                        
                        // 更改图标为勾选
                        this.innerHTML = '<i class="fa fa-check"></i>';
                        this.classList.remove('text-gray-500', 'hover:text-gray-700');
                        this.classList.add('text-green-500', 'hover:text-green-700');
                        row.dataset.editing = 'true';
                    }
                });
            });
        }

        // 删除所有客户记录功能
        const deleteAllButton = document.getElementById('delete-all-customers');
        deleteAllButton.addEventListener('click', function() {
            // 确认删除所有记录
            if (confirm('确定要永久性删除所有客户记录吗？此操作不可恢复！')) {
                // 清空数据
                customers = [];
                // 保存到localStorage
                localStorage.setItem('customers', JSON.stringify(customers));
                // 重新渲染表格
                renderCustomers();
                alert('所有客户记录已被永久性删除！');
            }
        });
        
        // 页面加载时初始化所有功能
        function initializeCustomerManagement() {
            initCustomers();
            bindCustomerPaginationEvents();
            bindCustomerSearchEvents();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeCustomerManagement);
    </script>

    <!-- 新建客户模态框 -->
    <div id="add-customer-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto z-10">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-800">新建客户</h3>
                    <button id="close-customer-modal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="add-customer-form" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">客户</label>
                            <input type="text" id="customer-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div>
                            <label for="contact-person" class="block text-sm font-medium text-gray-700 mb-1">联系人</label>
                            <input type="text" id="contact-person" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="phone-number" class="block text-sm font-medium text-gray-700 mb-1">电话</label>
                            <input type="tel" id="phone-number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label for="customer-type" class="block text-sm font-medium text-gray-700 mb-1">客户类型</label>
                            <select id="customer-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="制造商">制造商</option>
                                <option value="贸易商">贸易商</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">地址</label>
                        <input type="text" id="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="tax-number" class="block text-sm font-medium text-gray-700 mb-1">税号</label>
                            <input type="text" id="tax-number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label for="bank-name" class="block text-sm font-medium text-gray-700 mb-1">开户行</label>
                            <input type="text" id="bank-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                    <div>
                        <label for="bank-account" class="block text-sm font-medium text-gray-700 mb-1">账号</label>
                        <input type="text" id="bank-account" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="remarks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-customer-btn" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400">取消</button>
                    <button type="submit" class="px-4 py-2 text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50">保存</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 新建送货安排模态框 -->
    <div id="add-shipment-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto z-10">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">新建送货安排</h3>
                <button id="close-shipment-modal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="add-shipment-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="shipment-order-id" class="block text-sm font-medium text-gray-700 mb-1">订单编号</label>
                            <select id="shipment-order-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="">请选择订单编号</option>
                            </select>
                        </div>
                    <div>
                        <label for="shipment-customer" class="block text-sm font-medium text-gray-700 mb-1">客户</label>
                        <input type="text" id="shipment-customer" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="shipment-route" class="block text-sm font-medium text-gray-700 mb-1">路线</label>
                        <input type="text" id="shipment-route" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="shipment-date" class="block text-sm font-medium text-gray-700 mb-1">送货日期</label>
                        <input type="date" id="shipment-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="relative">
                            <label for="shipment-driver" class="block text-sm font-medium text-gray-700 mb-1">司机</label>
                            <input type="text" id="shipment-driver" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <div id="driver-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    <div>
                        <label for="shipment-phone" class="block text-sm font-medium text-gray-700 mb-1">电话</label>
                        <input type="tel" id="shipment-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="shipment-license" class="block text-sm font-medium text-gray-700 mb-1">车牌</label>
                        <input type="text" id="shipment-license" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="shipment-cost" class="block text-sm font-medium text-gray-700 mb-1">费用</label>
                        <input type="number" id="shipment-cost" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" step="0.01" min="0" required>
                    </div>

                </div>
                <div>
                    <label for="shipment-remarks" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="shipment-remarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-shipment-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新建发票模态框 -->
    <div id="add-invoice-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto z-10">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">新建发票</h3>
                <button id="close-invoice-modal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="add-invoice-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="invoice-order-id" class="block text-sm font-medium text-gray-700 mb-1">订单编号</label>
                        <select id="invoice-order-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">请选择订单编号</option>
                        </select>
                    </div>
                    <div>
                        <label for="invoice-customer" class="block text-sm font-medium text-gray-700 mb-1">客户</label>
                        <input type="text" id="invoice-customer" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="invoice-date" class="block text-sm font-medium text-gray-700 mb-1">开票日期</label>
                        <input type="date" id="invoice-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-1">发票号</label>
                        <input type="text" id="invoice-number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label for="invoice-amount" class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                        <input type="number" id="invoice-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" step="0.01" min="0" required>
                    </div>

                </div>
                <div>
                    <label for="invoice-remarks" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="invoice-remarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-invoice-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 通用分页功能实现
        // 定义表格配置
        const tableConfigs = {
            recentOrders: {
                tableBodyId: 'recentOrdersTableBody',
                deleteAllButtonId: 'recentOrdersDeleteAll',
                itemsPerPage: 5,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [], // 存储原始数据，用于搜索过滤
                currentFilters: {}
            },
            orders: {
                tableBodyId: 'ordersTableBody',
                deleteAllButtonId: 'ordersDeleteAll',
                itemsPerPage: 10,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [],
                currentFilters: {}
            },
            deliveries: {
                tableBodyId: 'deliveriesTableBody',
                deleteAllButtonId: 'shipmentsDeleteAll',
                itemsPerPage: 10,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [],
                currentFilters: {},
                sortColumn: null,
                sortDirection: 'asc' // 'asc' 或 'desc'
            },
            shipments: {
                tableBodyId: 'shipmentsTableBody',
                deleteAllButtonId: 'deleteAllShipmentsBtn',
                itemsPerPage: 10,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [],
                currentFilters: {}
            },
            invoices: {
                tableBodyId: 'invoicesTableBody',
                deleteAllButtonId: 'invoicesDeleteAll',
                itemsPerPage: 10,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [],
                currentFilters: {}
            },
            payments: {
                tableBodyId: 'paymentsTableBody',
                deleteAllButtonId: 'paymentsDeleteAll',
                itemsPerPage: 10,
                currentPage: 1,
                totalPages: 1,
                data: [],
                originalData: [],
                currentFilters: {}
            }
        };

        // 根据收发货记录计算并更新订单的滞留数量
        function updateOrderRetainQuantity() {
            // 获取收发货数据和订单数据
            const deliveriesData = tableConfigs.deliveries.originalData;
            const ordersData = tableConfigs.orders.originalData;
            
            // 创建订单编号到数量汇总的映射
            const orderQuantityMap = new Map();
            
            // 初始化订单数量汇总结构
            function getOrderQuantity(orderNumber) {
                if (!orderQuantityMap.has(orderNumber)) {
                    orderQuantityMap.set(orderNumber, {
                        roughTotal: 0,     // 毛坯数量总计
                        replateTotal: 0,   // 返镀数量总计
                        repairTotal: 0,    // 返修数量总计
                        scrapTotal: 0,     // 报废数量总计
                        electroplateTotal: 0 // 电镀数量总计
                    });
                }
                return orderQuantityMap.get(orderNumber);
            }
            
            // 遍历收发货记录，按订单编号汇总各项数量
            deliveriesData.forEach(delivery => {
                const orderNumber = delivery.cells[2];
                const deliveryType = delivery.cells[0]; // 收发类型
                const roughQuantity = parseInt(delivery.cells[5] || 0);
                const electroplateQuantity = parseInt(delivery.cells[6] || 0);
                const replateQuantity = parseInt(delivery.cells[7] || 0);
                const repairQuantity = parseInt(delivery.cells[8] || 0);
                const scrapQuantity = parseInt(delivery.cells[9] || 0);
                
                // 获取该订单的数量汇总
                const orderQuantity = getOrderQuantity(orderNumber);
                
                // 根据用户要求：所有数量无论收发类型都直接相加
                // 滞留数量=毛坯数量+返镀数量-返修数量-报废数量-电镀数量
                orderQuantity.roughTotal += roughQuantity;         // 毛坯数量直接相加
                orderQuantity.electroplateTotal += electroplateQuantity; // 电镀数量直接相加
                orderQuantity.replateTotal += replateQuantity;     // 返镀数量直接相加
                orderQuantity.repairTotal += repairQuantity;       // 返修数量直接相加
                orderQuantity.scrapTotal += scrapQuantity;         // 报废数量直接相加
            });
            
            // 计算每个订单的滞留数量：滞留数量=毛坯数量+返镀数量-返修数量-报废数量-电镀数量
            // 计算每个订单的良品数量：良品数量=毛坯数量-返镀数量-报废数量-滞留数量
            // 计算每个订单的差额：差额=数量-良品数量
            // 计算每个订单的状态
            // 更新订单数据中的滞留数量、良品数量、差额和状态字段
            ordersData.forEach(order => {
                const orderNumber = order.cells[4]; // 订单编号在订单数据的cells[4]位置
                const quantity = parseInt(order.cells[11] || 0); // 数量在订单数据的cells[11]位置
                
                if (orderQuantityMap.has(orderNumber)) {
                    const orderQuantity = orderQuantityMap.get(orderNumber);
                    // 计算滞留数量
                    const retainQuantity = orderQuantity.roughTotal + orderQuantity.replateTotal - 
                                         orderQuantity.repairTotal - orderQuantity.scrapTotal - 
                                         orderQuantity.electroplateTotal;
                    
                    // 计算良品数量：良品数量=毛坯数量-返镀数量-报废数量-滞留数量
                    const goodQuantity = orderQuantity.roughTotal - orderQuantity.replateTotal - 
                                       orderQuantity.scrapTotal - retainQuantity;
                    
                    // 计算差额：差额=数量-良品数量
                    const difference = quantity - goodQuantity;
                    
                    // 滞留数量在订单数据的cells[1]位置
                    order.cells[1] = retainQuantity.toString();
                    // 良品数量在订单数据的cells[2]位置
                    order.cells[2] = goodQuantity.toString();
                    // 差额在订单数据的cells[3]位置
                    order.cells[3] = difference.toString();
                    
                    // 计算状态
                    let status = '';
                    // 规则4：当良品数量=0时，状态为"待电镀"（蓝底白字）
                    if (goodQuantity === 0) {
                        status = '待电镀';
                    } else {
                        // 规则1：当差额≤0时，状态为"已完成"（绿底白字）
                        if (difference <= 0) {
                            status = '已完成';
                        } else {
                            // 计算报废率：报废数量/数量
                            const scrapRate = quantity > 0 ? (orderQuantity.scrapTotal / quantity) * 100 : 0;
                            // 规则2：当差额>0，而且报废数量/数量<0.3%，状态为"电镀中"（黄底白字）
                            if (scrapRate < 0.3) {
                                status = '电镀中';
                            } else {
                                // 规则3：当差额>0，而且报废数量/数量>0.3%，状态为"报废警告!"（红底白字）
                                status = '报废警告!';
                            }
                        }
                    }
                    // 状态在订单数据的cells[0]位置
                    order.cells[0] = status;
                } else {
                    // 如果没有对应的收发货记录，将滞留数量、良品数量都设置为0
                    order.cells[1] = '0';
                    order.cells[2] = '0';
                    // 计算差额：差额=数量-0
                    const difference = quantity - 0;
                    order.cells[3] = difference.toString();
                    
                    // 计算状态
                    let status = '';
                    // 规则4：当良品数量=0时，状态为"待电镀"（蓝底白字）
                    status = '待电镀';
                    // 状态在订单数据的cells[0]位置
                    order.cells[0] = status;
                }
            });
            
            // 保存更新后的订单数据到localStorage
            localStorage.setItem('ordersData', JSON.stringify(ordersData));
            
            // 更新tableConfigs中的原始数据
            tableConfigs.orders.originalData = ordersData;
            
            // 重新应用当前的筛选条件
            if (tableConfigs.orders.currentFilters) {
                performSearch('orders', tableConfigs.orders.currentFilters);
            } else {
                // 如果没有当前筛选条件，则直接使用原始数据
                tableConfigs.orders.data = [...ordersData];
                // 重新渲染订单表格
                renderTable('orders');
            }
            renderTable('recentOrders');
        }
        
        // 初始化所有表格功能
        function initializeAllTables() {
            // 为每个表格初始化功能
            Object.keys(tableConfigs).forEach(tableName => {
                initializeTable(tableName);
            });
            // 页面加载完成后自动计算并更新滞留数量
            updateOrderRetainQuantity();
        }

        // 初始化单个表格
        function initializeTable(tableName) {
            const config = tableConfigs[tableName];
            
            // 从localStorage加载数据或从DOM提取
            loadTableData(tableName);
            
            // 添加删除所有记录事件
            addDeleteAllEvent(tableName);
            
            // 添加搜索事件监听器
            addSearchEventListeners(tableName);
            
            // 渲染初始表格
            renderTable(tableName);
        }

        // 从DOM或localStorage加载表格数据
        function loadTableData(tableName, createSampleData = false) {
            const config = tableConfigs[tableName];
            const tableBody = document.getElementById(config.tableBodyId);
            
            if (!tableBody) return;
            
            // 从localStorage加载数据
            // 特殊处理shipments和invoices表格，因为它们的数据存储在各自的键下而不是'xxxData'键下
            const storageKey = (tableName === 'shipments' || tableName === 'invoices') ? tableName : `${tableName}Data`;
            let storedData = localStorage.getItem(storageKey);
            
            // 如果没有存储数据且是shipments表格，并且允许创建示例数据，则初始化一些示例数据
            if (!storedData && tableName === 'shipments' && createSampleData) {
                const sampleData = [
                    {
                        orderId: 'ORDER-2023-0014',
                        customer: '客户A',
                        route: '路线1',
                        date: '2023-10-01',
                        driver: '张三',
                        phone: '13800138001',
                        license: '粤A12345',
                        cost: '100.00',
                        remarks: '正常送货'
                    },
                    {
                        orderId: 'ORDER-2023-0013',
                        customer: '客户B',
                        route: '路线2',
                        date: '2023-10-02',
                        driver: '李四',
                        phone: '13800138002',
                        license: '粤A12346',
                        cost: '150.00',
                        remarks: '加急送货'
                    },
                    {
                        orderId: 'ORDER-2023-0012',
                        customer: '客户C',
                        route: '路线3',
                        date: '2023-10-03',
                        driver: '王五',
                        phone: '13800138003',
                        license: '粤A12347',
                        cost: '200.00',
                        remarks: '预约送货'
                    }
                ];
                localStorage.setItem('shipments', JSON.stringify(sampleData));
                storedData = localStorage.getItem('shipments');
            }
            
            if (storedData) {
                let parsedData = JSON.parse(storedData);
                
                // 数据格式兼容性处理：将对象格式转换为cells数组格式
                config.originalData = parsedData.map(item => {
                    // 如果是已经包含cells数组的数据项，直接返回，但对于deliveries表格要确保只保留11个数据列
                    if (item.cells && Array.isArray(item.cells)) {
                        if (tableName === 'deliveries') {
                            // 确保只保留11个数据列，不包含复选框列和操作列
                            return {
                                cells: item.cells.slice(0, 11).map(cell => cell || '')
                            };
                        }
                        return item;
                    }
                    
                    // 对于deliveries表格的数据对象，转换为cells数组格式
                    if (tableName === 'deliveries') {
                        // 根据deliveries表格的HTML结构，表头顺序为：
                        // 类型, 收发日期, 订单编号, 客户, 产品名称, 毛坯数量, 电镀数量, 返镀数量, 返修数量, 报废数量, 备注
                        // 注意：这里只生成11个数据列，不包含复选框列和操作列
                        return {
                            cells: [
                                '送货', // 类型
                                item.date || '', // 收发日期
                                item.orderId || '', // 订单编号
                                item.customer || '', // 客户
                                '', // 产品名称（原数据中没有）
                                '0', // 毛坯数量（原数据中没有）
                                '0', // 电镀数量（原数据中没有）
                                '0', // 返镀数量（原数据中没有）
                                '0', // 返修数量（原数据中没有）
                                '0', // 报废数量（原数据中没有）
                                item.route || '', // 备注
                            ]
                        };
                    }
                    
                    // 对于shipments表格的数据对象，转换为cells数组格式
                    if (tableName === 'shipments') {
                        // 根据shipments表格的HTML结构，表头顺序为：
                        // 订单编号, 客户, 路线, 送货日期, 司机, 电话, 车牌, 费用, 备注, 操作
                        // 格式化费用为货币形式
                        const cost = parseFloat(item.cost) || 0;
                        const formattedCost = `¥ ${formatNumber(cost, 2)}`;
                        
                        return {
                            cells: [
                                item.orderId || '', // 订单编号
                                item.customer || '', // 客户
                                item.route || '', // 路线
                                item.date || '', // 送货日期
                                item.driver || '', // 司机
                                item.phone || '', // 电话
                                item.license || '', // 车牌
                                formattedCost, // 费用（格式化显示）
                                item.remarks || '', // 备注（注意是remarks而不是remark）
                                '' // 操作列（空字符串，后续会动态生成）
                            ]
                        };
                    }
                    
                    // 对于invoices表格的数据对象，转换为cells数组格式
                    if (tableName === 'invoices') {
                        // 根据invoices表格的HTML结构，表头顺序为：
                        // 付款状态, 付款日期, 订单编号, 客户, 开票日期, 发票号, 金额, 备注, 操作
                        // 格式化金额为货币形式
                        const amount = parseFloat(item.amount) || 0;
                        const formattedAmount = `¥ ${formatNumber(amount, 2)}`;
                        
                        return {
                            cells: [
                                item.status || '已开票', // 付款状态
                                '', // 付款日期（留空）
                                item.orderId || '', // 订单编号
                                item.customer || '', // 客户
                                item.date || '', // 开票日期
                                item.number || '', // 发票号
                                formattedAmount, // 金额（格式化显示）
                                item.remarks || '', // 备注
                                '' // 操作列（空字符串，后续会动态生成）
                            ]
                        };
                    }
                    
                    // 默认返回空cells数组的数据项
                    return {
                        cells: []
                    };
                });
            } else {
                // 从DOM提取数据
                const rows = tableBody.querySelectorAll('.table-row');
                config.originalData = Array.from(rows).map(row => {
                    const cells = row.querySelectorAll('.table-cell');
                    // 简单提取文本内容，实际项目中可能需要更复杂的处理
                    return {
                        cells: Array.from(cells).map(cell => cell.textContent.trim())
                    };
                });
                // 保存到localStorage
                localStorage.setItem(storageKey, JSON.stringify(config.originalData));
            }
            
            // 初始化当前数据为原始数据
            config.data = [...config.originalData];
            
            // 对收发货管理表格进行排序：先按订单编号，再按时间倒序
            if (tableName === 'deliveries') {
                config.data.sort((a, b) => {
                    // 先按订单编号排序
                    const orderNumA = a.cells[2] || '';
                    const orderNumB = b.cells[2] || '';
                    if (orderNumA !== orderNumB) {
                        return orderNumA.localeCompare(orderNumB);
                    }
                    // 再按时间倒序排序
                    const dateA = new Date(a.cells[1]);
                    const dateB = new Date(b.cells[1]);
                    return dateB - dateA;
                });
            }
            
            // 如果是订单、收发货管理或开票收款管理表格，动态更新客户下拉框选项
            if (tableName === 'orders') {
                updateCustomerFilterOptions('orders');
            } else if (tableName === 'deliveries') {
                updateCustomerFilterOptions('deliveries');
            } else if (tableName === 'invoices') {
                updateCustomerFilterOptions('invoices');
            }
        }
        
        // 动态更新客户下拉框选项
        function updateCustomerFilterOptions(tableName = 'orders') {
            let customerFilterId, config, customerIndex;
            
            // 根据表格类型设置不同的参数
            if (tableName === 'orders') {
                customerFilterId = 'orders-customer-filter';
                config = tableConfigs.orders;
                customerIndex = 5; // 订单表格中客户列的索引
            } else if (tableName === 'deliveries') {
                customerFilterId = 'deliveries-customer-filter';
                config = tableConfigs.deliveries;
                customerIndex = 3; // 收发货表格中客户列的索引
            } else if (tableName === 'invoices') {
                customerFilterId = 'invoices-customer-filter';
                config = tableConfigs.invoices;
                customerIndex = 3; // 开票收款表格中客户列的索引
            } else {
                return; // 不支持的表格类型
            }
            
            const customerFilter = document.getElementById(customerFilterId);
            
            if (!customerFilter || !config || !config.originalData) return;
            
            // 提取所有唯一的客户名称
            const customers = [...new Set(config.originalData.map(item => item.cells[customerIndex]))];
            
            // 清空现有选项（保留第一个"所有客户"选项）
            customerFilter.innerHTML = '<option value="">所有客户</option>';
            
            // 添加新的客户选项
            customers.forEach(customer => {
                if (customer && customer !== '') {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    customerFilter.appendChild(option);
                }
            });
        }

        // 根据客户ID获取客户名称的函数
        function getCustomerNameById(customerId) {
            // 从localStorage获取客户数据
            const savedCustomers = localStorage.getItem('customers');
            if (savedCustomers) {
                const customers = JSON.parse(savedCustomers);
                const customer = customers.find(c => c.id.toString() === customerId.toString());
                return customer ? customer.name : customerId;
            }
            return customerId;
        }
        
        // 渲染表格
        function renderTable(tableName) {
            const config = tableConfigs[tableName];
            const tableBody = document.getElementById(config.tableBodyId);
            
            if (!tableBody) return;
            
            // 计算总页数
            config.totalPages = Math.ceil(config.data.length / config.itemsPerPage);
            // 确保当前页码不超过总页数
            if (config.currentPage > config.totalPages) {
                config.currentPage = config.totalPages || 1;
            }
            
            // 计算当前页的数据范围
            const startIndex = (config.currentPage - 1) * config.itemsPerPage;
            const endIndex = startIndex + config.itemsPerPage;
            const currentPageData = config.data.slice(startIndex, endIndex);
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 渲染当前页的数据
            currentPageData.forEach((item, itemIndex) => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                
                // 重建表格行，对于订单表格特殊处理数据顺序
                // 安全检查：确保item和item.cells存在且可迭代
                if (!item || typeof item.cells === 'undefined' || item.cells === null) {
                    console.error('表格数据项格式错误:', item);
                    return; // 跳过格式错误的数据项
                }
                let cells = [...item.cells];
                
                // 找到当前数据项在originalData中的真实索引
                let originalIndex = -1;
                if (tableName === 'deliveries') {
                    // 对于收发货表格，通过比较关键字段来找到真实索引
                    // 使用类型、日期和订单编号作为唯一标识
                    const type = cells[0];
                    const date = cells[1];
                    const orderNumber = cells[2];
                    
                    originalIndex = config.originalData.findIndex(origItem => {
                        const origCells = origItem.cells;
                        return origCells && origCells.length >= 3 && 
                               origCells[0] === type && 
                               origCells[1] === date && 
                               origCells[2] === orderNumber;
                    });
                    
                    if (originalIndex === -1) {
                        // 如果找不到，尝试使用完整的cells数组比较
                        originalIndex = config.originalData.findIndex(origItem => 
                            JSON.stringify(origItem.cells) === JSON.stringify(item.cells)
                        );
                    }
                } else {
                    // 其他表格使用原来的索引计算方式
                    originalIndex = (config.currentPage - 1) * config.itemsPerPage + itemIndex;
                }
                if (tableName === 'orders') {
                    // 对于订单表格，我们始终从原始数据中提取字段并重新构建数据结构，以确保一致性
                    
                    // 检查是否包含操作列（最后一列包含HTML按钮）
                    const hasActionColumn = cells.length > 0 && cells[cells.length - 1].includes('button');
                    // 如果有操作列，先移除
                    if (hasActionColumn) {
                        cells = cells.slice(0, -1);
                    }
                    
                    let orderNumber, customer, orderDate, deliveryDate, technicalRequirements, productName, specification, quantity, unitPrice, amount, remarks, status;
                    
                    // 根据数据长度确定数据结构
                    if (cells.length === 15) {
                        // 新的数据结构：[状态, 滞留数量, 良品数量, 差额, 订单编号, 客户, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注]
                        status = cells[0] || '';
                        const retainQuantity = cells[1] || '';
                        const goodQuantity = cells[2] || '';
                        const difference = cells[3] || '';
                        orderNumber = cells[4] || '';
                        customer = cells[5] || '';
                        orderDate = cells[6] || '';
                        deliveryDate = cells[7] || '';
                        technicalRequirements = cells[8] || '';
                        productName = cells[9] || '';
                        specification = cells[10] || '';
                        quantity = cells[11] || '';
                        unitPrice = cells[12] || '';
                        amount = cells[13] || '';
                        remarks = cells[14] || '';
                        
                        // 保持原有数据结构，只确保顺序正确
                        cells = [
                            status,                      // 状态列
                            retainQuantity,              // 滞留数量列
                            goodQuantity,                // 良品数量列
                            difference,                  // 差数列
                            orderNumber,                 // 订单编号列
                            customer,                    // 客户列
                            orderDate,                   // 订单日期列
                            deliveryDate,                // 交货日期列
                            technicalRequirements,       // 技术要求列
                            productName,                 // 产品名称列
                            specification,               // 规格列
                            quantity,                    // 数量列
                            unitPrice,                   // 单价列
                            amount,                      // 金额列
                            remarks                      // 备注列
                        ];
                    } else {
                        // 原始数据结构：[订单编号, 客户ID, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注, 状态, 操作按钮]
                        
                        // 将客户ID转换为客户名称
                        if (cells.length > 1) {
                            cells[1] = getCustomerNameById(cells[1]);
                        }
                        
                        // 从原始数据中提取各个字段
                        orderNumber = cells[0] || '';
                        customer = cells[1] || '';
                        orderDate = cells[2] || '';
                        deliveryDate = cells[3] || '';
                        technicalRequirements = cells[4] || '';
                        productName = cells[5] || '';
                        specification = cells[6] || '';
                        quantity = cells[7] || '';
                        unitPrice = cells[8] || '';
                        amount = cells[9] || '';
                        remarks = cells[10] || '';
                        status = cells[11] || '';
                        
                        // 计算差数
                        const quantityNum = parseFloat(quantity) || 0;
                        const goodQuantity = '0'; // 初始化为0，后续可以修改
                        const difference = (quantityNum - parseFloat(goodQuantity)).toString();
                        
                        // 按照新的表头顺序重建cells数组：[状态, 滞留数量, 良品数量, 差额, 订单编号, 客户, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注]
                        cells = [
                            status,                      // 状态列
                            '',                          // 滞留数量列（新增）
                            goodQuantity,                // 良品数量列（新增）
                            difference,                  // 差数列（新增）
                            orderNumber,                 // 订单编号列
                            customer,                    // 客户列
                            orderDate,                   // 订单日期列
                            deliveryDate,                // 交货日期列
                            technicalRequirements,       // 技术要求列
                            productName,                 // 产品名称列
                            specification,               // 规格列
                            quantity,                    // 数量列
                            unitPrice,                   // 单价列
                            amount,                      // 金额列
                            remarks                      // 备注列
                        ];
                    }
                    
                    // 只在非收发货管理表格中添加操作列，收发货表格的操作列在后面单独处理
                    if (tableName !== 'deliveries') {
                        const editButton = '<button class="text-gray-500 hover:text-gray-700 mr-3 edit-button"><i class="fa fa-edit"></i></button>';
                        const deleteButton = '<button class="text-danger hover:text-danger/80 delete-button"><i class="fa fa-trash"></i></button>';
                        cells.push(editButton + deleteButton);
                    }
                } else if (tableName === 'shipments') {
                    // 对于送货安排表格，更新操作列内容
                    // 使用正确的索引：当前页起始索引 + 当前页内的索引
                    const originalIndex = (config.currentPage - 1) * config.itemsPerPage + itemIndex;
                    const editButton = '<button class="text-primary hover:text-primary/80 mr-3 edit-shipment" data-index="' + originalIndex + '"><i class="fa fa-edit"></i></button>';
                    const deleteButton = '<button class="text-danger hover:text-danger/80 delete-shipment" data-index="' + originalIndex + '"><i class="fa fa-trash"></i></button>';
                    if (cells.length > 9) {
                        cells[9] = `${editButton}${deleteButton}`; // 更新操作列内容
                    }
                } else if (tableName === 'recentOrders') {
                    // 对于最近订单表格，保持原来的处理逻辑
                    if (cells.length > 2) {
                        cells[2] = getCustomerNameById(cells[2]);
                    }
                }
                
                // 对于收发货管理表格，确保只保留11个数据列，并移除null值
                if (tableName === 'deliveries') {
                    cells = cells.slice(0, 11).map(cell => cell || ''); // 替换null为空白字符串，只保留11个数据列
                }
                
                // 构建表格行HTML
                let rowHTML = '';
                
                // 对于订单表格，先添加复选框列
                if (tableName === 'orders') {
                    rowHTML += '<td class="table-cell"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"></td>';
                }
                
                // 对于收发货管理表格，先添加复选框列
                if (tableName === 'deliveries') {
                    rowHTML += '<td class="table-cell"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary deliveries-select-row"></td>';
                    
                    // 移除重复的类型列，解决显示两个"类型"值的问题
                    if (cells.length > 1 && cells[0] === cells[1]) {
                        cells.splice(1, 1); // 移除第二个类型列
                    }
                }
                

                
                cells.forEach((cell, index) => {
                    // 处理千分位格式化
                    let formattedCell = cell;
                    
                    // 根据表格类型和列索引确定需要格式化的列
                    if (tableName === 'deliveries') {
                        // 收发货管理表格：数量列（索引5-9）
                        if ([5, 6, 7, 8, 9].includes(index)) {
                            formattedCell = formatNumber(cell, 0);
                        }
                    } else if (tableName === 'orders') {
                        // 订单管理表格：滞留数量(1), 良品数量(2), 差额(3), 数量(11), 金额(13)
                        if ([1, 2, 3, 11, 13].includes(index)) {
                            formattedCell = formatNumber(cell, index === 13 ? 2 : 0);
                        }
                    } else if (tableName === 'shipments') {
                        // 送货安排表格：费用列（索引7）
                        if (index === 7) {
                            formattedCell = formatNumber(cell, 2);
                        }
                    } else if (tableName === 'invoices') {
                        // 开票管理表格：金额列（索引6）
                        if (index === 6) {
                            formattedCell = formatNumber(cell, 2);
                        }
                    } else if (tableName === 'payments') {
                        // 收款记录表格：金额列（索引4）
                        if (index === 4) {
                            formattedCell = formatNumber(cell, 2);
                        }
                    }
                    
                    if (tableName === 'deliveries') {
                        // 收发货管理表格的特殊处理
                        if (index === 0) {
                            // 第一列是类型列，添加颜色样式
                            let typeClass = '';
                            if (formattedCell === '发货') {
                                typeClass = 'bg-red-100 text-red-800 px-2 py-1 rounded font-medium';
                            } else if (formattedCell === '收货') {
                                typeClass = 'bg-green-100 text-green-800 px-2 py-1 rounded font-medium';
                            }
                            // 添加类型列
                            rowHTML += `<td class="table-cell"><span class="${typeClass}">${formattedCell}</span></td>`;
                        } else {
                            // 其他列显示格式化后的值
                            rowHTML += `<td class="table-cell">${formattedCell}</td>`;
                        }
                    } else if ((tableName === 'orders' || tableName === 'recentOrders') && index === 0) {
                        // 订单表格和最近订单表格的状态列特殊处理
                        let statusClass = 'status-badge';
                        // 根据状态值选择对应的样式类
                        if (formattedCell === '待电镀') {
                            statusClass += ' status-processing';
                        } else if (formattedCell === '已完成') {
                            statusClass += ' status-completed';
                        } else if (formattedCell === '电镀中') {
                            statusClass += ' status-pending';
                        } else if (formattedCell === '报废警告!') {
                            statusClass += ' status-cancelled';
                        }
                        // 添加状态列
                        rowHTML += `<td class="table-cell"><span class="${statusClass}">${formattedCell}</span></td>`;
                    } else if (tableName === 'invoices') {
                        if (index === 0) {
                            // 发票表格的付款状态列特殊处理
                            let statusClass = 'status-badge';
                            // 根据状态值选择对应的样式类
                            if (formattedCell === '已开票') {
                                statusClass += ' status-processing';
                            } else if (formattedCell === '已付款') {
                                statusClass += ' status-completed';
                            } else if (formattedCell === '待开票') {
                                statusClass += ' status-pending';
                            } else if (formattedCell === '已逾期') {
                                statusClass += ' status-cancelled';
                            }
                            // 添加状态列
                            rowHTML += `<td class="table-cell"><span class="${statusClass}">${formattedCell}</span></td>`;
                        } else if (index === 1) {
                            // 发票表格的付款日期列特殊处理
                            if (formattedCell && formattedCell !== '-') {
                                // 有记录时显示为日历选择框
                                rowHTML += `<td class="table-cell"><input type="date" value="${formattedCell}" class="form-input w-full"></td>`;
                            } else {
                                // 没有记录时显示为空的日历选择框
                                rowHTML += `<td class="table-cell"><input type="date" class="form-input w-full"></td>`;
                            }
                        } else {
                            // 发票表格的其他列显示格式化后的值
                            rowHTML += `<td class="table-cell">${formattedCell}</td>`;
                        }
                    } else {
                        // 其他表格的列显示格式化后的值
                        rowHTML += `<td class="table-cell">${formattedCell}</td>`;
                    }
                });
                
                // 对于收发货管理表格，在所有数据列之后添加操作列
                if (tableName === 'deliveries') {
                    // 使用已经计算好的originalIndex
                    const editButton = '<button class="text-gray-500 hover:text-gray-700 mr-3 edit-button" data-row-index="' + originalIndex + '"><i class="fa fa-edit"></i></button>';
                    const deleteButton = '<button class="text-danger hover:text-danger/80 delete-button" data-row-index="' + originalIndex + '"><i class="fa fa-trash"></i></button>';
                    // 确保索引有效
                    if (originalIndex === -1) {
                        console.error('无法找到数据项在originalData中的索引:', cells);
                    }
                    // 为发货记录添加生成发货单按钮
                    let generateButton = '';
                    if (cells[0] === '发货') {
                        generateButton = '<button class="text-blue-500 hover:text-blue-700 mr-3 generate-delivery-button" data-row-index="' + originalIndex + '"><i class="fa fa-file-pdf-o"></i></button>';
                    }
                    rowHTML += `<td class="table-cell">${generateButton}${editButton}${deleteButton}</td>`;
                } 

                
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
                
                // 为发票表格的操作按钮添加data-row-index属性
                if (tableName === 'invoices') {
                    const editButton = row.querySelector('.edit-button');
                    const deleteButton = row.querySelector('.delete-button');
                    if (editButton && deleteButton) {
                        // 计算当前数据项在完整数据数组中的索引
                        const dataIndex = startIndex + itemIndex;
                        editButton.dataset.rowIndex = dataIndex;
                        deleteButton.dataset.rowIndex = dataIndex;
                    }
                }
            });
            
            // 实现发票编辑功能
            function editInvoice(index) {
                // 从localStorage获取发票数据
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices[index];
                
                if (!invoice) {
                    showToast('未找到该发票信息！', 'error');
                    return;
                }
                
                // 先设置当前编辑的索引
                document.getElementById('add-invoice-form').dataset.editIndex = index;
                
                // 填充订单编号下拉框选项
                populateInvoiceOrderNumbers();
                
                // 填充表单字段
                document.getElementById('invoice-order-id').value = invoice.orderId;
                document.getElementById('invoice-customer').value = invoice.customer;
                document.getElementById('invoice-date').value = invoice.date;
                document.getElementById('invoice-number').value = invoice.number;
                document.getElementById('invoice-amount').value = invoice.amount;
                document.getElementById('invoice-remarks').value = invoice.remarks;
                
                // 修改模态框标题
                document.getElementById('add-invoice-modal').querySelector('h3').textContent = '编辑发票';
                
                // 显示模态框（使用与closeInvoiceModal函数一致的方式）
                document.getElementById('add-invoice-modal').classList.remove('hidden');
                
                // 显示提示
                showToast('请修改发票信息并保存', 'info');
                
                // 恢复页面滚动
                document.body.style.overflow = 'hidden';
            }
            
            // 实现发票删除功能
            function deleteInvoice(index) {
                // 从localStorage获取发票数据
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices[index];
                
                if (!invoice) {
                    showToast('未找到该发票信息！', 'error');
                    return;
                }
                
                // 确认删除
                if (confirm('确定要删除这张发票吗？')) {
                    // 从数组中移除发票
                    invoices.splice(index, 1);
                    
                    // 保存到localStorage
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    
                    // 更新tableConfigs
                    const config = tableConfigs.invoices;
                    config.originalData = [...invoices];
                    config.data = [...invoices];
                    
                    // 更新表格
                    renderTable('invoices');
                    
                    // 显示成功提示
                    showToast('发票已成功删除！', 'success');
                }
            }
            
            // 为发票表格添加事件监听器
            if (tableName === 'invoices') {
                // 编辑按钮事件监听器
                const editButtons = document.querySelectorAll('#invoicesTableBody .table-cell .edit-button');
                editButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const rowIndex = parseInt(this.dataset.rowIndex);
                        editInvoice(rowIndex);
                    });
                });
                
                // 删除按钮事件监听器
                const deleteButtons = document.querySelectorAll('#invoicesTableBody .table-cell .delete-button');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const rowIndex = parseInt(this.dataset.rowIndex);
                        deleteInvoice(rowIndex);
                    });
                });
            }
            
            // 为订单表格添加事件监听器
            if (tableName === 'orders' || tableName === 'deliveries') {
                const tableBodyId = tableName === 'orders' ? '#ordersTableBody' : '#deliveriesTableBody';
                const storageKey = tableName === 'orders' ? 'ordersData' : 'deliveriesData';
                const message = tableName === 'orders' ? '订单' : '收发货单';
                const totalColumns = tableName === 'orders' ? 17 : 13; // 订单17列，收发货13列（含复选框和操作列）
                
                // 编辑按钮事件监听器
                const editButtons = document.querySelectorAll(`${tableBodyId} .table-cell .edit-button`);
                editButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const row = this.closest('.table-row');
                        const cells = row.querySelectorAll('.table-cell');
                        const isEditing = row.dataset.editing === 'true';
                        
                        if (isEditing) {
                            // 保存编辑
                            let rowIndex;
                            if (tableName === 'deliveries') {
                                // 收发货管理表格：强制使用data-row-index属性获取原始索引
                                rowIndex = parseInt(this.getAttribute('data-row-index'));
                            } else {
                                // 其他表格：通过计算获取索引
                                const startIndex = (config.currentPage - 1) * config.itemsPerPage;
                                rowIndex = startIndex + Array.from(tableBody.children).indexOf(row);
                            }
                            
                            if (rowIndex !== -1 && rowIndex < config.originalData.length) {
                                // 更新数据
                                let updatedCells = [];
                                if (tableName === 'deliveries') {
                                    // 收发货管理表格：跳过复选框列(0)和操作列(最后一列)
                                    for (let i = 1; i < cells.length - 1; i++) {
                                        // 获取输入值
                                        const input = cells[i].querySelector('input');
                                        if (input) {
                                            updatedCells.push(input.value.trim());
                                        } else {
                                            updatedCells.push(cells[i].textContent.trim());
                                        }
                                    }
                                    // 确保只保存11个数据列（收发货管理表格）
                                    updatedCells.splice(11);
                                } else if (tableName === 'orders') {
                                    // 订单表格特殊处理：保持与渲染时相同的数据结构
                                    
                                    // 先从原始数据获取当前行数据作为基础
                                    const originalCells = config.originalData[rowIndex].cells || [];
                                    
                                    // 创建与渲染时一致的数据结构
                                    // 渲染时的顺序：[状态, 滞留数量, 良品数量, 差额, 订单编号, 客户, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注]
                                    const cellValues = [...originalCells]; // 先复制原始数据，避免数据丢失
                                    
                                    // 从DOM中获取数据并映射到正确的字段位置
                                    let updatedOrderNumber = originalCells[4] || ''; // 保存原始订单编号作为默认值
                                    
                                    for (let i = 0; i < cells.length; i++) {
                                        if (i === 0) {
                                            // 复选框列保持原始数据
                                            cellValues[0] = originalCells[0] || '';
                                        } else if (i < cells.length - 1) { // 跳过操作列
                                            const input = cells[i].querySelector('input');
                                            const value = input ? input.value.trim() : cells[i].textContent.trim();
                                            
                                            // DOM列索引与数据结构索引的映射关系
                                            // DOM列：1=状态, 2=滞留数量, 3=良品数量, 4=差额, 5=订单编号, 6=客户, 7=订单日期, 8=交货日期, 9=技术要求, 10=产品名称, 11=规格, 12=数量, 13=单价, 14=金额, 15=备注
                                            // 数据结构：0=状态, 1=滞留数量, 2=良品数量, 3=差额, 4=订单编号, 5=客户, 6=订单日期, 7=交货日期, 8=技术要求, 9=产品名称, 10=规格, 11=数量, 12=单价, 13=金额, 14=备注
                                            const dataIndex = i - 1;
                                            
                                            // 确保索引在有效范围内
                                            if (dataIndex >= 0 && dataIndex < 15) {
                                                cellValues[dataIndex] = value;
                                                
                                                // 如果是订单编号字段，保存更新后的值
                                                if (dataIndex === 4) {
                                                    updatedOrderNumber = value;
                                                }
                                            }
                                        }
                                    }
                                    
                                    // 检查订单编号是否存在（排除当前行）
                                    if (updatedOrderNumber !== originalCells[4] && isOrderNumberExists(updatedOrderNumber, rowIndex)) {
                                        alert('订单编号已存在，请使用不同的订单编号！');
                                        return; // 阻止保存
                                    }
                                    
                                    // 确保所有字段都有值，避免undefined
                                    for (let i = 0; i < 15; i++) {
                                        if (typeof cellValues[i] === 'undefined') {
                                            cellValues[i] = '';
                                        }
                                    }
                                    
                                    // 确保数据长度正确
                                    updatedCells = cellValues;
                                } else {
                                    // 其他表格
                                    for (let i = 0; i < cells.length; i++) {
                                        if (i === 0) {
                                            // 复选框列保持不变
                                            updatedCells.push(config.originalData[rowIndex].cells[0]);
                                        } else if (i < 12) { // 只处理前12个数据列（不包括操作列）
                                            // 其他列获取输入值
                                            const input = cells[i].querySelector('input');
                                            if (input) {
                                                updatedCells.push(input.value.trim());
                                            } else {
                                                updatedCells.push(cells[i].textContent.trim());
                                            }
                                        }
                                        // 操作列不保存到原始数据中
                                    }
                                }
                                
                                // 更新originalData
                                config.originalData[rowIndex] = {
                                    cells: updatedCells
                                };
                                
                                // 保存到localStorage
                                localStorage.setItem(storageKey, JSON.stringify(config.originalData));
                                
                                // 更新表格显示
                                for (let i = 0; i < cells.length; i++) {
                                    if (i !== 0 && i !== totalColumns - 1) {
                                        const input = cells[i].querySelector('input');
                                        if (input) {
                                            cells[i].textContent = input.value.trim();
                                        }
                                    }
                                }
                                
                                // 恢复编辑图标
                                const icon = this.querySelector('i');
                                if (icon) {
                                    icon.className = 'fa fa-edit';
                                }
                                row.dataset.editing = 'false';
                                
                                // 更新搜索和分页数据
                                config.data = [...config.originalData];
                                
                                // 如果是收发货单，自动计算并更新订单的滞留数量
                                if (tableName === 'deliveries') {
                                    updateOrderRetainQuantity();
                                }
                                
                                alert(`${message}信息已更新！`);
                            }
                        } else {
                            // 进入编辑模式
                            // 获取行类型（发货/收货）
                            const rowType = cells[1].textContent.trim();
                            
                            for (let i = 0; i < cells.length; i++) {
                                // 排除复选框列(0)、操作列(totalColumns-1)和特定字段列
                                if (i !== 0 && i !== totalColumns - 1) {
                                    // 判断是否为订单表格且是需要排除的特定字段
                                    if (tableName === 'orders') {
                                        // 状态(1)、滞留数量(2)、良品数量(3)、差额(4)这4项不显示输入框
                                        if (i >= 1 && i <= 4) {
                                            continue; // 跳过这些列，不创建输入框
                                        }
                                    }
                                    
                                    // 其他列变为可编辑输入框
                                    const value = cells[i].textContent.trim();
                                    
                                    // 根据表格类型和行类型设置只读状态
                                    if (tableName === 'deliveries') {
                                        // 判断是否为需要设置只读的字段
                                        const isReturnPlatingReadonly = (rowType === '发货' && i === 8); // 发货时返镀数量只读
                                        const isPlatingReadonly = (rowType === '收货' && i === 7); // 收货时电镀数量只读
                                        const isRepairReadonly = (rowType === '收货' && i === 9); // 收货时返修数量只读
                                        
                                        // 如果是需要只读的字段，添加readonly属性
                                        if (isReturnPlatingReadonly || isPlatingReadonly || isRepairReadonly) {
                                            cells[i].innerHTML = `<input type="text" value="${value}" class="form-input w-full min-w-[200px]" readonly />`;
                                        } else {
                                            cells[i].innerHTML = `<input type="text" value="${value}" class="form-input w-full min-w-[200px]" />`;
                                        }
                                    } else {
                                        // 非收发货表格，直接创建输入框
                                        cells[i].innerHTML = `<input type="text" value="${value}" class="form-input w-full min-w-[200px]" />`;
                                    }
                                }
                            }
                            
                            // 更改图标为勾选图标
                            const icon = this.querySelector('i');
                            if (icon) {
                                icon.className = 'fa fa-check';
                            }
                            row.dataset.editing = 'true';
                        }
                    });
                });
                
                // 删除按钮事件监听器
                const deleteButtons = document.querySelectorAll(`${tableBodyId} .table-cell .delete-button`);
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (confirm(`确定要删除这条${message}记录吗？`)) {
                            let rowIndex;
                            if (tableName === 'deliveries') {
                                // 收发货管理表格：强制使用data-row-index属性获取原始索引
                                rowIndex = parseInt(this.getAttribute('data-row-index'));
                            } else {
                                // 其他表格：通过计算获取索引
                                const startIndex = (config.currentPage - 1) * config.itemsPerPage;
                                const row = this.closest('.table-row');
                                rowIndex = startIndex + Array.from(tableBody.children).indexOf(row);
                            }
                            
                            if (rowIndex !== -1 && rowIndex < config.originalData.length) {
                                // 从数据中删除
                                config.originalData.splice(rowIndex, 1);
                                
                                // 保存到localStorage
                                localStorage.setItem(storageKey, JSON.stringify(config.originalData));
                                
                                // 更新搜索和分页数据
                                config.data = [...config.originalData];
                                
                                // 重新渲染表格
                                renderTable(tableName);
                                
                                // 如果是收发货单，自动计算并更新订单的滞留数量
                                if (tableName === 'deliveries') {
                                    updateOrderRetainQuantity();
                                }
                                
                                alert(`${message}已删除！`);
                            }
                        }
                    });
                });
                
                // 生成发货单按钮事件监听器
                if (tableName === 'deliveries') {
                    const generateButtons = document.querySelectorAll(`${tableBodyId} .table-cell .generate-delivery-button`);
                    generateButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const row = this.closest('.table-row');
                            const startIndex = (config.currentPage - 1) * config.itemsPerPage;
                            const rowIndex = startIndex + Array.from(tableBody.children).indexOf(row);
                            
                            // 检查是否有选中的行
                            const checkboxes = document.querySelectorAll(`${tableBodyId} input.deliveries-select-row`);
                            const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
                            
                            let selectedRowsData = [];
                            
                            // 获取送货安排表格的数据
                            const shipmentsData = tableConfigs.shipments.originalData;
                            
                            if (selectedCheckboxes.length > 0) {
                                // 如果有选中的行，获取所有选中行的数据
                                selectedRowsData = selectedCheckboxes.map(checkbox => {
                                    const selectedRow = checkbox.closest('.table-row');
                                    const selectedRowIndex = startIndex + Array.from(tableBody.children).indexOf(selectedRow);
                                    
                                    if (selectedRowIndex !== -1 && selectedRowIndex < config.data.length) {
                                        const rowData = config.data[selectedRowIndex].cells;
                                        
                                        // 从送货安排表格中查找相同订单号且日期相同的记录
                                        const shipment = shipmentsData.find(item => {
                                            return item.cells[0] === rowData[2] && item.cells[3] === rowData[1];
                                        });
                                        
                                        // 转换为适合发货单的格式
                            return {
                                type: rowData[0],
                                date: rowData[1],
                                orderNumber: rowData[2],
                                customer: rowData[3],
                                product: rowData[4],
                                productName: rowData[4], // 产品名称
                                rawQuantity: rowData[5] || '0',  // 毛坯数量列索引应该是5，确保不为空
                                electroplateQuantity: rowData[6] || '0',  // 电镀数量列索引应该是6，确保不为空
                                reworkQuantity: rowData[7] || '0',  // 返镀数量列索引应该是7，确保不为空
                                repairQuantity: rowData[8] || '0',  // 返修数量列索引应该是8，确保不为空
                                deliveryQuantity: '1箱', // 默认值，可根据实际情况调整
                                driver: shipment ? shipment.cells[4] : '', // 司机
                                phone: shipment ? shipment.cells[5] : '', // 电话
                                licensePlate: shipment ? shipment.cells[6] : '' // 车牌
                            };
                                    }
                                    return null;
                                }).filter(data => data !== null);
                            } else if (rowIndex !== -1 && rowIndex < config.data.length) {
                                // 如果没有选中的行，只获取当前行的数据
                                const rowData = config.data[rowIndex].cells;
                                
                                // 从送货安排表格中查找相同订单号且日期相同的记录
                                const shipment = shipmentsData.find(item => {
                                    return item.cells[0] === rowData[2] && item.cells[3] === rowData[1];
                                });
                                
                                // 转换为适合发货单的格式
                                selectedRowsData = [{
                                    type: rowData[0],
                                    date: rowData[1],
                                    orderNumber: rowData[2],
                                    customer: rowData[3],
                                    product: rowData[4],
                                    productName: rowData[4], // 产品名称
                                    rawQuantity: rowData[5] || '0',  // 毛坯数量列索引应该是5，确保不为空
                                    electroplateQuantity: rowData[6] || '0',  // 电镀数量列索引应该是6，确保不为空
                                    reworkQuantity: rowData[7] || '0',  // 返镀数量列索引应该是7，确保不为空
                                    repairQuantity: rowData[8] || '0',  // 返修数量列索引应该是8，确保不为空
                                    deliveryQuantity: '1箱', // 默认值，可根据实际情况调整
                                    driver: shipment ? shipment.cells[4] : '', // 司机
                                    phone: shipment ? shipment.cells[5] : '', // 电话
                                    licensePlate: shipment ? shipment.cells[6] : '' // 车牌
                                }];
                            }
                            
                            if (selectedRowsData.length > 0) {
                                // 使用sessionStorage将数据传递给发货单页面
                                sessionStorage.setItem('selectedDeliveries', JSON.stringify(selectedRowsData));
                                
                                // 打开发货单页面，添加时间戳参数避免浏览器缓存
                                const timestamp = new Date().getTime();
                                window.open('电镀产品发货单.html?timestamp=' + timestamp, '_blank');
                            }
                        });
                    });
                }
                

            }
            
            // 更新分页控件
            updatePaginationControls(tableName);
            
            // 为订单、收发货管理、送货安排、开票管理和收款记录表格添加合计功能
            if (tableName === 'orders' || tableName === 'deliveries' || tableName === 'shipments' || tableName === 'invoices' || tableName === 'payments') {
                renderTotalRow(tableName);
                
                // 为复选框添加事件监听器，以便在选中状态改变时重新计算合计
                const checkboxes = document.querySelectorAll(`#${config.tableBodyId} input[type="checkbox"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        renderTotalRow(tableName);
                    });
                });
            }
            
            // 为发票表格的付款日期输入框添加事件监听器
            if (tableName === 'invoices') {
                const dateInputs = document.querySelectorAll(`#${config.tableBodyId} input[type="date"]`);
                dateInputs.forEach((input, inputIndex) => {
                    input.addEventListener('change', () => {
                        const selectedDate = input.value;
                        if (selectedDate) {
                            // 获取当前行在原始数据中的索引
                            const rowIndex = (config.currentPage - 1) * config.itemsPerPage + inputIndex;
                            
                            if (rowIndex < config.originalData.length) {
                                // 更新付款日期
                                config.originalData[rowIndex].cells[1] = selectedDate;
                                
                                // 将付款状态从"已开票"自动改为"已付款"
                                if (config.originalData[rowIndex].cells[0] === '已开票') {
                                    config.originalData[rowIndex].cells[0] = '已付款';
                                }
                                
                                // 保存到localStorage
                                const storageKey = 'invoices'; // invoices表格使用tableName作为存储键名
                                localStorage.setItem(storageKey, JSON.stringify(config.originalData));
                                
                                // 更新搜索和分页数据
                                config.data = [...config.originalData];
                                
                                // 重新渲染表格
                                renderTable(tableName);
                                
                                alert('付款日期已保存，付款状态已更新！');
                            }
                        }
                    });
                });
            }
        }
        
        // 渲染合计行
        function renderTotalRow(tableName) {
            const config = tableConfigs[tableName];
            const tableBody = document.getElementById(config.tableBodyId);
            
            if (!tableBody) return;
            
            // 移除已存在的合计行
            const existingTotalRow = tableBody.parentElement.querySelector('.total-row');
            if (existingTotalRow) {
                existingTotalRow.remove();
            }
            
            // 检查是否有选中的行
            const checkboxes = document.querySelectorAll(`#${config.tableBodyId} input[type="checkbox"]`);
            const selectedRows = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.closest('.table-row'));
            
            let dataToSum = [];
            
            if (selectedRows.length > 0) {
                // 如果有选中的行，只计算选中行的合计
                dataToSum = selectedRows.map(row => {
                    const cells = row.querySelectorAll('.table-cell');
                    return Array.from(cells).slice(1, -1).map(cell => cell.textContent.trim()); // 跳过复选框列和操作列
                });
            } else {
                // 如果没有选中的行，计算当前页所有行的合计
                dataToSum = config.data.slice((config.currentPage - 1) * config.itemsPerPage, config.currentPage * config.itemsPerPage)
                    .map(item => item.cells); // item.cells已经是正确的数据结构，不需要跳过任何列
            }
            
            // 计算合计
            const totals = calculateTotals(dataToSum, tableName);
            
            // 创建合计行
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row bg-gray-50 font-semibold';
            
            // 创建合计行的单元格
            let totalCells;
            
            if (tableName === 'deliveries') {
                // 收发货管理表格的合计行
                totalCells = [
                    '<td class="table-cell"></td>', // 复选框列
                    '<td class="table-cell font-semibold">合计：</td>', // 类型列
                    '<td class="table-cell"></td>', // 收发日期列
                    '<td class="table-cell"></td>', // 订单编号列
                    '<td class="table-cell"></td>', // 客户名称列
                    '<td class="table-cell"></td>', // 产品名称列
                    `<td class="table-cell">${totals.roughQuantity}</td>`, // 毛坯数量列
                    `<td class="table-cell">${totals.electroplateQuantity}</td>`, // 电镀数量列
                    `<td class="table-cell">${totals.replateQuantity}</td>`, // 返镀数量列
                    `<td class="table-cell">${totals.repairQuantity}</td>`, // 修模数量列
                    `<td class="table-cell">${totals.scrapQuantity}</td>`, // 报废数量列
                    '<td class="table-cell"></td>', // 备注列
                    '<td class="table-cell"></td>' // 操作列
                ];
            } else if (tableName === 'shipments') {
                // 送货安排表格的合计行
                totalCells = [
                    '<td class="table-cell"></td>', // 空列
                    '<td class="table-cell"></td>', // 订单编号列
                    '<td class="table-cell"></td>', // 客户列
                    '<td class="table-cell"></td>', // 路线列
                    '<td class="table-cell"></td>', // 送货日期列
                    '<td class="table-cell"></td>', // 司机列
                    '<td class="table-cell"></td>', // 电话列
                    `<td class="table-cell font-semibold">合计：${formatNumber(totals.fee, 2)}</td>`, // 费用列（移到左侧一列）
                    '<td class="table-cell"></td>', // 车牌列（移到右侧一列）
                    '<td class="table-cell"></td>', // 备注列
                    '<td class="table-cell"></td>' // 操作列
                ];
            } else if (tableName === 'invoices') {
                // 开票管理表格的合计行 - 合计结果往左移一列
                totalCells = [
                    '<td class="table-cell font-semibold">合计：</td>', // 空列移到付款状态列
                    '<td class="table-cell"></td>', // 付款日期列
                    '<td class="table-cell"></td>', // 订单编号列
                    '<td class="table-cell"></td>', // 客户列
                    '<td class="table-cell"></td>', // 开票日期列
                    '<td class="table-cell"></td>', // 发票号列
                    `<td class="table-cell font-semibold">¥${totals.amount}</td>`, // 金额列（左移一列）
                    '<td class="table-cell"></td>', // 备注列
                    '<td class="table-cell"></td>' // 操作列
                ];
            } else if (tableName === 'payments') {
                // 收款记录表格的合计行 - 合计结果往左移一列
                totalCells = [
                    '<td class="table-cell font-semibold">合计：</td>', // 收款编号列
                    '<td class="table-cell"></td>', // 发票编号列
                    '<td class="table-cell"></td>', // 客户列
                    `<td class="table-cell font-semibold">¥${totals.amount}</td>`, // 金额列（左移一列）
                    '<td class="table-cell"></td>', // 收款方式列
                    '<td class="table-cell"></td>', // 参考号列
                    '<td class="table-cell"></td>' // 操作列
                ];
            } else {
                // 订单管理表格的合计行
                totalCells = [
                    '<td class="table-cell"></td>', // 复选框列
                    '<td class="table-cell font-semibold">合计：</td>', // 状态列
                    `<td class="table-cell">${totals.retainQuantity}</td>`, // 滞留数量列
                    `<td class="table-cell">${totals.goodQuantity}</td>`, // 良品数量列
                    `<td class="table-cell">${totals.difference}</td>`, // 差额列
                    '<td class="table-cell"></td>', // 订单编号列
                    '<td class="table-cell"></td>', // 客户列
                    '<td class="table-cell"></td>', // 订单日期列
                    '<td class="table-cell"></td>', // 交货日期列
                    '<td class="table-cell"></td>', // 技术要求列
                    '<td class="table-cell"></td>', // 产品名称列
                    '<td class="table-cell"></td>', // 规格列
                    `<td class="table-cell">${totals.quantity}</td>`, // 数量列
                    '<td class="table-cell">-</td>', // 单价列（不需要汇总）
                    `<td class="table-cell">${totals.amount}</td>`, // 金额列
                    '<td class="table-cell"></td>', // 备注列
                    '<td class="table-cell"></td>' // 操作列
                ];
            }
            
            totalRow.innerHTML = totalCells.join('');
            
            // 将合计行添加到表格末尾
            tableBody.parentElement.appendChild(totalRow);
        }
        
        // 计算合计
        function calculateTotals(data, tableName = 'orders') {
            // 辅助函数：解析数值，先移除货币符号和其他非数字字符
            function parseNumber(value) {
                return parseFloat((value || '').replace(/[^\d.]/g, '')) || 0;
            }
            

            
            // 初始化订单管理表格的合计变量
            let retainQuantity = 0;
            let goodQuantity = 0;
            let difference = 0;
            let quantity = 0;
            let amount = 0;
            
            // 初始化收发货管理表格的合计变量（5个数量列）
            let roughQuantity = 0;
            let electroplateQuantity = 0;
            let replateQuantity = 0;
            let repairQuantity = 0;
            let scrapQuantity = 0;
            
            // 初始化送货安排表格的合计变量
            let fee = 0;
            
            data.forEach(row => {
                
                if (tableName === 'deliveries') {
                    // 收发货管理表格的数据结构
                    // 根据行数据结构确定需要汇总的列索引
                    let roughQuantityIndex, electroplateQuantityIndex, replateQuantityIndex, repairQuantityIndex, scrapQuantityIndex;
                    
                    if (row.length === 10 || row.length === 11) {
                        // 数据存储结构：[类型, 收发日期, 订单编号, 客户名称, 产品名称, 毛坯数量, 电镀数量, 返镀数量, 修模数量, 报废数量, 备注]
                        roughQuantityIndex = 5;
                        electroplateQuantityIndex = 6;
                        replateQuantityIndex = 7;
                        repairQuantityIndex = 8;
                        scrapQuantityIndex = 9;
                    } else if (row.length === 12 || row.length === 13) {
                        // 表格显示的数据结构（包含复选框和操作列）：[复选框, 类型, 收发日期, 订单编号, 客户名称, 产品名称, 毛坯数量, 电镀数量, 返镀数量, 修模数量, 报废数量, 备注, 操作]
                        roughQuantityIndex = 6;
                        electroplateQuantityIndex = 7;
                        replateQuantityIndex = 8;
                        repairQuantityIndex = 9;
                        scrapQuantityIndex = 10;
                    } else {
                        // 默认索引
                        roughQuantityIndex = 5;
                        electroplateQuantityIndex = 6;
                        replateQuantityIndex = 7;
                        repairQuantityIndex = 8;
                        scrapQuantityIndex = 9;
                    }
                    
                    // 累加各数量列
                    roughQuantity += parseNumber(row[roughQuantityIndex]);
                    electroplateQuantity += parseNumber(row[electroplateQuantityIndex]);
                    replateQuantity += parseNumber(row[replateQuantityIndex]);
                    repairQuantity += parseNumber(row[repairQuantityIndex]);
                    scrapQuantity += parseNumber(row[scrapQuantityIndex]);
                } else if (tableName === 'shipments') {
                    // 送货安排表格的数据结构
                    // 费用列在第8列（索引7）
                    let feeIndex = 7;
                    
                    // 累加费用列
                    fee += parseNumber(row[feeIndex]);
                } else if (tableName === 'invoices') {
                    // 开票管理表格的数据结构
                    // 金额列在第8列（索引7）
                    let amountIndex = 6;
                    
                    // 累加金额列
                    amount += parseNumber(row[amountIndex]);
                } else if (tableName === 'payments') {
                    // 收款记录表格的数据结构
                    // 金额列在第5列（索引4）
                    let amountIndex = 4;
                    
                    // 累加金额列
                    amount += parseNumber(row[amountIndex]);
                } else {
                    // 订单管理表格的处理逻辑保持不变
                    // 根据行数据结构确定需要汇总的列索引
                    let retainQuantityIndex, goodQuantityIndex, differenceIndex, quantityIndex, amountIndex;
                    
                    if (row.length === 15) {
                        // 新的数据结构：[状态, 滞留数量, 良品数量, 差额, 订单编号, 客户, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注]
                        retainQuantityIndex = 1;
                        goodQuantityIndex = 2;
                        differenceIndex = 3;
                        quantityIndex = 11;
                        amountIndex = 13;
                    } else if (row.length === 12) {
                        // 原始数据结构：[订单编号, 客户ID, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注, 状态]
                        // 原始数据结构可能没有滞留数量、良品数量和差额列
                        retainQuantityIndex = -1;
                        goodQuantityIndex = -1;
                        differenceIndex = -1;
                        quantityIndex = 7;
                        amountIndex = 9;
                    } else if (row.length === 16) {
                        // 表格显示的数据结构（包含复选框和操作列）：[复选框, 状态, 滞留数量, 良品数量, 差额, 订单编号, 客户, 订单日期, 交货日期, 技术要求, 产品名称, 规格, 数量, 单价, 金额, 备注, 操作]
                        retainQuantityIndex = 2;
                        goodQuantityIndex = 3;
                        differenceIndex = 4;
                        quantityIndex = 12;
                        amountIndex = 14;
                    } else {
                        // 默认索引
                        retainQuantityIndex = 2;
                        goodQuantityIndex = 3;
                        differenceIndex = 4;
                        quantityIndex = 12;
                        amountIndex = 14;
                    }
                    
                    // 累加各列
                    if (retainQuantityIndex !== -1) {
                        retainQuantity += parseNumber(row[retainQuantityIndex]);
                    }
                    if (goodQuantityIndex !== -1) {
                        goodQuantity += parseNumber(row[goodQuantityIndex]);
                    }
                    if (differenceIndex !== -1) {
                        difference += parseNumber(row[differenceIndex]);
                    }
                    quantity += parseNumber(row[quantityIndex]);
                    amount += parseNumber(row[amountIndex]);
                }
            });
            
            if (tableName === 'deliveries') {
                // 返回收发货管理表格的合计值
                return {
                    roughQuantity: formatNumber(roughQuantity, 0),
                    electroplateQuantity: formatNumber(electroplateQuantity, 0),
                    replateQuantity: formatNumber(replateQuantity, 0),
                    repairQuantity: formatNumber(repairQuantity, 0),
                    scrapQuantity: formatNumber(scrapQuantity, 0)
                };
            } else if (tableName === 'shipments') {
                // 返回送货安排表格的合计值
                return {
                    fee: fee
                };
            } else if (tableName === 'invoices' || tableName === 'payments') {
                // 返回开票管理和收款记录表格的合计值
                return {
                    amount: formatNumber(amount, 2)
                };
            } else {
                // 返回订单管理表格的合计值
                return {
                    retainQuantity: formatNumber(retainQuantity, 0),
                    goodQuantity: formatNumber(goodQuantity, 0),
                    difference: formatNumber(difference, 0),
                    quantity: formatNumber(quantity, 0),
                    amount: formatNumber(amount, 2)
                };
            }
        }

        // 更新分页控件
        function updatePaginationControls(tableName) {
            const config = tableConfigs[tableName];
            const tableBody = document.getElementById(config.tableBodyId);
            
            if (!tableBody) return;
            
            // 查找或创建分页控件容器
            let paginationContainer = tableBody.parentElement.nextElementSibling;
            if (!paginationContainer || !paginationContainer.classList.contains('pagination-container')) {
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination-container';
                paginationContainer.style.display = 'flex';
                paginationContainer.style.justifyContent = 'space-between';
                paginationContainer.style.alignItems = 'center';
                paginationContainer.style.marginTop = '1rem';
                paginationContainer.style.paddingTop = '1rem';
                paginationContainer.style.borderTop = '1px solid #e2e8f0';
                tableBody.parentElement.parentElement.appendChild(paginationContainer);
            }
            
            // 创建左侧部分：记录统计和每页显示条数选择
            const leftSection = document.createElement('div');
            leftSection.style.display = 'flex';
            leftSection.style.alignItems = 'center';
            
            // 创建记录统计
            const recordCount = document.createElement('div');
            recordCount.className = 'text-sm text-gray-500';
            const startIndex = (config.currentPage - 1) * config.itemsPerPage + 1;
            const endIndex = Math.min(config.currentPage * config.itemsPerPage, config.data.length);
            recordCount.textContent = `显示 ${startIndex} 到 ${endIndex} 条，共 ${config.data.length} 条记录`;
            
            // 创建每页显示条数选择
            const perPageSelect = document.createElement('select');
            perPageSelect.className = 'ml-4 px-2 py-1 text-sm border border-gray-300 rounded-md';
            perPageSelect.innerHTML = `
                <option value="5">5条/页</option>
                <option value="10">10条/页</option>
                <option value="20">20条/页</option>
                <option value="50">50条/页</option>
                <option value="100">100条/页</option>
            `;
            perPageSelect.value = config.itemsPerPage;
            perPageSelect.addEventListener('change', (e) => {
                config.itemsPerPage = parseInt(e.target.value);
                config.currentPage = 1; // 重置为第一页
                renderTable(tableName);
            });
            
            // 组装左侧部分
            leftSection.appendChild(recordCount);
            leftSection.appendChild(perPageSelect);
            
            // 创建右侧部分：分页按钮和跳转功能
            const rightSection = document.createElement('div');
            rightSection.style.display = 'flex';
            rightSection.style.alignItems = 'center';
            
            // 创建分页按钮容器
            const paginationControls = document.createElement('div');
            paginationControls.className = 'flex items-center space-x-2';
            
            // 首页按钮
            const firstPageBtn = document.createElement('button');
            firstPageBtn.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            firstPageBtn.innerHTML = '<i class="fa fa-angle-double-left"></i> 首页';
            firstPageBtn.disabled = config.currentPage === 1;
            firstPageBtn.addEventListener('click', () => {
                config.currentPage = 1;
                renderTable(tableName);
            });
            
            // 上一页按钮
            const prevBtn = document.createElement('button');
            prevBtn.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            prevBtn.innerHTML = '<i class="fa fa-chevron-left"></i> 上一页';
            prevBtn.disabled = config.currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (config.currentPage > 1) {
                    config.currentPage--;
                    renderTable(tableName);
                }
            });
            
            // 页码信息
            const pageInfo = document.createElement('div');
            pageInfo.className = 'text-sm';
            pageInfo.textContent = `第 ${config.currentPage} / ${config.totalPages || 1} 页`;
            
            // 下一页按钮
            const nextBtn = document.createElement('button');
            nextBtn.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            nextBtn.innerHTML = '下一页 <i class="fa fa-chevron-right"></i>';
            nextBtn.disabled = config.currentPage === config.totalPages || config.totalPages === 0;
            nextBtn.addEventListener('click', () => {
                if (config.currentPage < config.totalPages) {
                    config.currentPage++;
                    renderTable(tableName);
                }
            });
            
            // 末页按钮
            const lastPageBtn = document.createElement('button');
            lastPageBtn.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            lastPageBtn.innerHTML = '末页 <i class="fa fa-angle-double-right"></i>';
            lastPageBtn.disabled = config.currentPage === config.totalPages || config.totalPages === 0;
            lastPageBtn.addEventListener('click', () => {
                config.currentPage = config.totalPages;
                renderTable(tableName);
            });
            
            // 跳转功能
            const jumpSection = document.createElement('div');
            jumpSection.style.display = 'flex';
            jumpSection.style.alignItems = 'center';
            jumpSection.style.marginLeft = '1rem';
            
            const jumpText = document.createElement('span');
            jumpText.className = 'text-sm text-gray-500';
            jumpText.textContent = '跳转至';
            
            const jumpInput = document.createElement('input');
            jumpInput.type = 'number';
            jumpInput.className = 'mx-2 px-2 py-1 text-sm border border-gray-300 rounded-md w-12';
            jumpInput.min = '1';
            jumpInput.max = config.totalPages || 1;
            jumpInput.value = config.currentPage;
            
            const jumpBtn = document.createElement('button');
            jumpBtn.className = 'px-3 py-1 text-sm border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50';
            jumpBtn.textContent = '确定';
            jumpBtn.addEventListener('click', () => {
                const jumpPage = parseInt(jumpInput.value);
                if (jumpPage >= 1 && jumpPage <= (config.totalPages || 1)) {
                    config.currentPage = jumpPage;
                    renderTable(tableName);
                }
            });
            
            // 回车键跳转
            jumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const jumpPage = parseInt(jumpInput.value);
                    if (jumpPage >= 1 && jumpPage <= (config.totalPages || 1)) {
                        config.currentPage = jumpPage;
                        renderTable(tableName);
                    }
                }
            });
            
            // 组装跳转功能
            jumpSection.appendChild(jumpText);
            jumpSection.appendChild(jumpInput);
            jumpSection.appendChild(jumpBtn);
            
            // 组装分页按钮
            paginationControls.appendChild(firstPageBtn);
            paginationControls.appendChild(prevBtn);
            paginationControls.appendChild(pageInfo);
            paginationControls.appendChild(nextBtn);
            paginationControls.appendChild(lastPageBtn);
            paginationControls.appendChild(jumpSection);
            
            // 组装右侧部分
            rightSection.appendChild(paginationControls);
            
            // 更新容器内容
            paginationContainer.innerHTML = '';
            paginationContainer.appendChild(leftSection);
            paginationContainer.appendChild(rightSection);
        }

        // 添加删除所有记录事件
        function addDeleteAllEvent(tableName) {
            const config = tableConfigs[tableName];
            const deleteAllBtn = document.getElementById(config.deleteAllButtonId);
            
            if (!deleteAllBtn) return;
            
            deleteAllBtn.addEventListener('click', () => {
                // 确认删除所有记录
                if (confirm(`确定要永久性删除所有记录吗？此操作不可恢复！`)) {
                    // 清空数据
                    config.data = [];
                    // 保存到localStorage（使用与loadTableData相同的存储键名逻辑）
                    let storageKey = `${tableName}Data`;
                    if (tableName === 'shipments' || tableName === 'invoices') {
                        storageKey = tableName;
                    }
                    localStorage.setItem(storageKey, JSON.stringify(config.data));
                    // 重新渲染表格
                    renderTable(tableName);
                    alert('所有记录已被永久性删除！');
                }
            });
        }

        // 添加搜索功能事件监听器
        function addSearchEventListeners(tableName) {
            const config = tableConfigs[tableName];
            let searchBtn, searchInput, statusFilter, driverFilter, customerFilter, methodFilter, dateInput, startDate, endDate;
            
            // 根据表格类型获取对应的搜索控件
            switch(tableName) {
                case 'recentOrders':
                    searchBtn = document.getElementById('recentOrders-search-btn');
                    searchInput = document.getElementById('recentOrders-search-input');
                    statusFilter = document.getElementById('recentOrders-status-filter');
                    break;
                case 'orders':
                    searchBtn = document.getElementById('orders-search-btn');
                    searchInput = document.getElementById('orders-search-input');
                    statusFilter = document.getElementById('orders-status-filter');
                    customerFilter = document.getElementById('orders-customer-filter');
                    startDate = document.getElementById('orders-start-date');
                    endDate = document.getElementById('orders-end-date');
                    break;
                case 'deliveries':
                    searchBtn = document.getElementById('deliveries-search-btn');
                    searchInput = document.getElementById('deliveries-search-input');
                    customerFilter = document.getElementById('deliveries-customer-filter');
                    startDate = document.getElementById('deliveries-start-date');
                    endDate = document.getElementById('deliveries-end-date');
                    break;
                case 'shipments':
                    searchBtn = document.getElementById('shipments-search-btn');
                    searchInput = document.getElementById('shipments-search-input');
                    statusFilter = document.getElementById('shipments-status-filter');
                    driverFilter = document.getElementById('shipments-driver-filter');
                    startDate = document.getElementById('shipments-start-date');
                    endDate = document.getElementById('shipments-end-date');
                    break;
                case 'invoices':
                    searchBtn = document.getElementById('invoices-search-btn');
                    searchInput = document.getElementById('invoices-search-input');
                    statusFilter = document.getElementById('invoices-status-filter');
                    customerFilter = document.getElementById('invoices-customer-filter');
                    startDate = document.getElementById('invoices-start-date');
                    endDate = document.getElementById('invoices-end-date');
                    break;
                case 'payments':
                    searchBtn = document.getElementById('payments-search-btn');
                    searchInput = document.getElementById('payments-search-input');
                    customerFilter = document.getElementById('payments-customer-filter');
                    methodFilter = document.getElementById('payments-method-filter');
                    startDate = document.getElementById('payments-start-date');
                    endDate = document.getElementById('payments-end-date');
                    break;
            }
            
            // 添加搜索按钮点击事件
            if (searchBtn) {
                searchBtn.addEventListener('click', () => {
                    performSearch(tableName, {
                        searchInput: searchInput?.value || '',
                        statusFilter: statusFilter?.value || '',
                        driverFilter: driverFilter?.value || '',
                        customerFilter: customerFilter?.value || '',
                        methodFilter: methodFilter?.value || '',
                        dateInput: dateInput?.value || '',
                        startDate: startDate?.value || '',
                        endDate: endDate?.value || ''
                    });
                });
            }
            
            // 为invoices表格的付款状态下拉框添加即时筛选功能
            if (tableName === 'invoices' && statusFilter) {
                statusFilter.addEventListener('change', () => {
                    performSearch(tableName, {
                        searchInput: searchInput?.value || '',
                        statusFilter: statusFilter?.value || '',
                        driverFilter: driverFilter?.value || '',
                        customerFilter: customerFilter?.value || '',
                        methodFilter: methodFilter?.value || '',
                        dateInput: dateInput?.value || '',
                        startDate: startDate?.value || '',
                        endDate: endDate?.value || ''
                    });
                });
            }
            
            // 添加重置按钮点击事件
            if (tableName === 'shipments') {
                const resetBtn = document.getElementById('shipments-reset-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        // 重置所有筛选条件
                        if (searchInput) searchInput.value = '';
                        if (driverFilter) driverFilter.value = '';
                        if (startDate) startDate.value = '';
                        if (endDate) endDate.value = '';
                        
                        // 执行搜索，显示所有数据
                        performSearch(tableName, {
                            searchInput: '',
                            statusFilter: '',
                            driverFilter: '',
                            customerFilter: '',
                            methodFilter: '',
                            dateInput: '',
                            startDate: '',
                            endDate: ''
                        });
                    });
                }
            } else if (tableName === 'invoices') {
                const resetBtn = document.getElementById('invoices-reset-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        // 重置所有筛选条件
                        if (searchInput) searchInput.value = '';
                        if (statusFilter) statusFilter.value = '';
                        if (customerFilter) customerFilter.value = '';
                        if (startDate) startDate.value = '';
                        if (endDate) endDate.value = '';
                        
                        // 执行搜索，显示所有数据
                        performSearch(tableName, {
                            searchInput: '',
                            statusFilter: '',
                            driverFilter: '',
                            customerFilter: '',
                            methodFilter: '',
                            dateInput: '',
                            startDate: '',
                            endDate: ''
                        });
                    });
                }
            }
            
            // 添加回车键搜索支持
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch(tableName, {
                            searchInput: searchInput.value,
                            statusFilter: statusFilter?.value || '',
                            driverFilter: driverFilter?.value || '',
                            customerFilter: customerFilter?.value || '',
                            methodFilter: methodFilter?.value || '',
                            dateInput: dateInput?.value || '',
                            startDate: startDate?.value || '',
                            endDate: endDate?.value || ''
                        });
                    }
                });
                
                // 为订单管理、收发货管理和送货安排表格添加实时搜索功能
                if (tableName === 'orders' || tableName === 'deliveries' || tableName === 'shipments') {
                    searchInput.addEventListener('input', () => {
                        performSearch(tableName, {
                            searchInput: searchInput.value,
                            statusFilter: statusFilter?.value || '',
                            driverFilter: driverFilter?.value || '',
                            customerFilter: customerFilter?.value || '',
                            startDate: startDate?.value || '',
                            endDate: endDate?.value || ''
                        });
                    });
                }
            }
            
            // 添加重置按钮功能
            if (tableName === 'orders' || tableName === 'deliveries') {
                const resetBtn = document.getElementById(tableName === 'orders' ? 'orders-reset-btn' : 'deliveries-reset-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        // 重置所有筛选条件
                        if (searchInput) searchInput.value = '';
                        if (statusFilter) statusFilter.value = '';
                        if (customerFilter) customerFilter.value = '';
                        if (startDate) startDate.value = '';
                        if (endDate) endDate.value = '';
                        
                        // 执行搜索以显示所有记录
                        performSearch(tableName, {
                            searchInput: '',
                            statusFilter: '',
                            customerFilter: '',
                            startDate: '',
                            endDate: ''
                        });
                    });
                }
            }
        }
        
        // 执行搜索
        function performSearch(tableName, filters) {
            const config = tableConfigs[tableName];
            
            // 保存当前过滤条件
            config.currentFilters = filters;
            
            // 重置当前页码到第1页
            config.currentPage = 1;
            
            // 根据过滤条件筛选数据
            config.data = config.originalData.filter(item => {
                const cells = item.cells;
                let match = true;
                
                // 文本搜索
                if (filters.searchInput && match) {
                    const searchTerm = filters.searchInput.toLowerCase();
                    match = cells.some(cell => cell.toLowerCase().includes(searchTerm));
                }
                
                // 状态筛选
                if (filters.statusFilter && filters.statusFilter !== '' && match) {
                    if (tableName === 'recentOrders' || tableName === 'orders') {
                        // 订单表格：状态在第1列（索引0）
                        match = cells[0] === filters.statusFilter;
                    } else {
                        // 其他表格：检查所有单元格
                        match = cells.some(cell => cell.includes(filters.statusFilter));
                    }
                }
                
                // 司机筛选
                if (filters.driverFilter && filters.driverFilter !== '' && match) {
                    if (tableName === 'shipments') {
                        // 送货安排表格：司机信息在第5列（索引4）
                        match = cells[4] && cells[4].includes(filters.driverFilter);
                    } else {
                        // 其他表格：假设司机信息在第3列（索引2）
                        match = cells[2] && cells[2].includes(filters.driverFilter);
                    }
                }
                
                // 客户筛选
                if (filters.customerFilter && filters.customerFilter !== '' && match) {
                    if (tableName === 'orders') {
                        // 订单表格：客户信息在第6列（索引5）
                        match = cells[5] && cells[5].includes(filters.customerFilter);
                    } else if (tableName === 'deliveries') {
                        // 收发货表格：客户信息在第5列（索引4）
                        match = cells[4] && cells[4].includes(filters.customerFilter);
                    } else {
                        // 其他表格：假设客户信息在第3列（索引2）
                        match = cells[2] && cells[2].includes(filters.customerFilter);
                    }
                }
                
                // 收款方式筛选
                if (filters.methodFilter && filters.methodFilter !== '' && match) {
                    // 假设收款方式在第3列
                    match = cells[2] && cells[2].includes(filters.methodFilter);
                }
                
                // 日期筛选
                if (filters.dateInput && match) {
                    // 订单日期在第3列
                    match = cells[3] && cells[3].includes(filters.dateInput);
                }
                
                // 日期范围筛选
                if ((filters.startDate || filters.endDate) && match) {
                    const start = filters.startDate ? new Date(filters.startDate) : new Date(0);
                    const end = filters.endDate ? new Date(filters.endDate) : new Date(8640000000000000);
                    
                    if (tableName === 'deliveries') {
                        // 收发货管理表格：收发日期在第2列
                        const deliveryDate = new Date(cells[2]);
                        // 添加日期有效性检查
                        if (isNaN(deliveryDate.getTime())) {
                            // 如果日期无效，则不应用日期筛选
                            match = true;
                        } else {
                            match = deliveryDate >= start && deliveryDate <= end;
                        }
                    } else if (tableName === 'shipments') {
                        // 送货安排表格：送货日期在第4列（索引3）
                        const shipmentDate = new Date(cells[3]);
                        // 添加日期有效性检查
                        if (isNaN(shipmentDate.getTime())) {
                            // 如果日期无效，则不应用日期筛选
                            match = true;
                        } else {
                            match = shipmentDate >= start && shipmentDate <= end;
                        }
                    } else {
                        // 其他表格：订单日期在第3列，交货日期在第4列
                        const orderDate = new Date(cells[3]);
                        const deliveryDate = new Date(cells[4]);
                        // 检查订单日期或交货日期是否在范围内，添加日期有效性检查
                        const isOrderDateValid = !isNaN(orderDate.getTime());
                        const isDeliveryDateValid = !isNaN(deliveryDate.getTime());
                        
                        if (!isOrderDateValid && !isDeliveryDateValid) {
                            // 如果两个日期都无效，则不应用日期筛选
                            match = true;
                        } else if (!isOrderDateValid) {
                            // 如果只有订单日期无效，则只检查交货日期
                            match = deliveryDate >= start && deliveryDate <= end;
                        } else if (!isDeliveryDateValid) {
                            // 如果只有交货日期无效，则只检查订单日期
                            match = orderDate >= start && orderDate <= end;
                        } else {
                            // 如果两个日期都有效，则检查其中任何一个是否在范围内
                            match = (orderDate >= start && orderDate <= end) || (deliveryDate >= start && deliveryDate <= end);
                        }
                    }
                }
                
                return match;
            });
            
            // 重新渲染表格以应用搜索结果
            renderTable(tableName);
        }

        // 表格排序函数
        function sortTable(tableName, columnIndex) {
            const config = tableConfigs[tableName];
            
            // 切换排序方向
            if (config.sortColumn === columnIndex) {
                config.sortDirection = config.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                config.sortColumn = columnIndex;
                config.sortDirection = 'asc';
            }
            
            // 执行排序
            config.data.sort((a, b) => {
                const aValue = a.cells[columnIndex];
                const bValue = b.cells[columnIndex];
                
                // 检查是否是日期列（收发日期列索引为1）
                if (tableName === 'deliveries' && columnIndex === 1) {
                    // 日期比较
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    if (isNaN(aDate.getTime()) || isNaN(bDate.getTime())) {
                        // 如果日期无效，按字符串比较
                        const aStr = aValue.toString().toLowerCase();
                        const bStr = bValue.toString().toLowerCase();
                        return config.sortDirection === 'asc' ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);
                    }
                    return config.sortDirection === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // 尝试将值转换为数字进行比较
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    // 数字比较
                    return config.sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                } else {
                    // 字符串比较
                    const aStr = aValue.toString().toLowerCase();
                    const bStr = bValue.toString().toLowerCase();
                    
                    if (aStr < bStr) return config.sortDirection === 'asc' ? -1 : 1;
                    if (aStr > bStr) return config.sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });
            
            // 重置到第1页
            config.currentPage = 1;
            
            // 更新表头排序状态显示
            if (tableName === 'deliveries') {
                const table = document.getElementById('deliveriesTable');
                const headers = table.querySelectorAll('thead th');
                
                // 清除所有表头的排序图标
                headers.forEach((header, index) => {
                    if (index >= 1 && index <= 11) { // 只处理第2到12列
                        // 先保存原始文本内容
                        const textContent = header.textContent.trim();
                        // 重置innerHTML为原始文本
                        header.innerHTML = textContent;
                    }
                });
                
                // 添加当前排序列的图标
                const currentHeader = headers[columnIndex + 1]; // 加上复选框列的偏移
                const icon = config.sortDirection === 'asc' ? '<i class="fa fa-sort-asc ml-1"></i>' : '<i class="fa fa-sort-desc ml-1"></i>';
                currentHeader.innerHTML += icon;
            }
            
            // 重新渲染表格
            renderTable(tableName);
        }
        
        // 修改initializeTable函数
        function initializeTable(tableName) {
            const config = tableConfigs[tableName];
            
            // 从localStorage加载数据或从DOM提取
            loadTableData(tableName);
            
            // 添加删除所有记录事件
            addDeleteAllEvent(tableName);
            
            // 添加搜索事件监听器
            addSearchEventListeners(tableName);
            
            // 为收发货表格添加表头排序事件监听器
            if (tableName === 'deliveries') {
                const table = document.getElementById('deliveriesTable');
                const headers = table.querySelectorAll('thead th');
                
                // 为第2到12列（索引1到11）的表头添加点击事件监听器
                for (let i = 1; i <= 11; i++) {
                    headers[i].addEventListener('click', () => {
                        // 计算对应的cells数组索引（减去复选框列和类型列的偏移）
                        const columnIndex = i - 1;
                        sortTable('deliveries', columnIndex);
                    });
                    
                    // 添加鼠标悬停效果，提示可点击排序
                    headers[i].style.cursor = 'pointer';
                }
            }
            
            // 渲染初始表格
            renderTable(tableName);
        }
        
        // 页面加载完成后初始化所有表格
        document.addEventListener('DOMContentLoaded', function() {
            // 调试：检查localStorage中的收发货数据
            console.log('=== 收发货管理表格调试信息 ===');
            const localStorageDeliveries = localStorage.getItem('deliveriesData');
            if (localStorageDeliveries) {
                try {
                    const parsedDeliveries = JSON.parse(localStorageDeliveries);
                    console.log('localStorage中的deliveriesData记录数:', parsedDeliveries.length);
                    
                    // 检查发货记录
                    const deliveryRecords = parsedDeliveries.filter(item => item.cells[0] === '发货');
                    console.log('发货记录数:', deliveryRecords.length);
                    console.log('发货记录详情:', deliveryRecords);
                    
                    // 检查收货记录
                    const receiveRecords = parsedDeliveries.filter(item => item.cells[0] === '收货');
                    console.log('收货记录数:', receiveRecords.length);
                } catch (e) {
                    console.error('解析deliveriesData失败:', e);
                }
            } else {
                console.log('localStorage中没有deliveriesData');
            }
            
            initializeAllTables();
            
            // 初始化时自动计算并更新滞留数量
            updateOrderRetainQuantity();
            
            // 调试：验证订单数据顺序是否正确
            console.log('=== 订单表格修复调试信息 ===');
            const ordersData = tableConfigs.orders.originalData;
            if (ordersData.length > 0) {
                console.log('订单数据样例：', ordersData[0]);
                
                // 检查数据顺序是否正确
                const headers = ['状态', '滞留数量', '良品数量', '差额', '订单编号', '客户', '订单日期', '交货日期', '技术要求', '产品名称', '规格', '数量', '单价', '金额', '备注'];
                const sampleOrder = ordersData[0].cells;
                
                if (sampleOrder.length === 15) {
                    console.log('数据字段与表头对应关系：');
                    headers.forEach((header, index) => {
                        console.log(`${header} (索引${index}): ${sampleOrder[index]}`);
                    });
                    
                    // 验证订单编号是否在正确的位置
                    console.log('订单编号位置验证：');
                    console.log('订单编号应在第5列（索引4）:', sampleOrder[4]);
                    console.log('差额应在第4列（索引3）:', sampleOrder[3]);
                    console.log('滞留数量应在第2列（索引1）:', sampleOrder[1]);
                }
            }
        });
    </script>
    <script>
        // 新建收发货单模态框处理
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框元素
            const addDeliveryModal = document.getElementById('add-delivery-modal');
            const addDeliveryBtn = document.getElementById('add-delivery-btn');
            const cancelDeliveryBtn = document.getElementById('cancel-delivery');
            const addDeliveryForm = document.getElementById('add-delivery-form');
            const deliveryDate = document.getElementById('delivery-date');
            const deliveryOrderId = document.getElementById('delivery-order-id');
            const deliveryProduct = document.getElementById('delivery-product');
            const deliveryCustomer = document.getElementById('delivery-customer');
            const deliveryType = document.getElementById('delivery-type');
            const deliveryRaw = document.getElementById('delivery-raw');
            const deliveryElectroplate = document.getElementById('delivery-electroplate');
            const deliveryReplate = document.getElementById('delivery-replate');
            const deliveryRepair = document.getElementById('delivery-repair');
            
            // 设置收发日期默认为今日
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            deliveryDate.value = formattedDate;
            
            // 从订单管理表格获取订单编号、产品名称和客户信息
            function populateOrderNumbers() {
                const orderTable = document.getElementById('ordersTable');
                if (!orderTable) return;
                
                const rows = orderTable.querySelectorAll('tbody tr');
                
                // 清空下拉框
                deliveryOrderId.innerHTML = '<option value="">请选择订单编号</option>';
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 11) {
                        // 根据新的表头顺序，订单编号在第6列（索引5），客户在第7列（索引6），产品名称在第11列（索引10）
                        const orderNumber = cells[5].textContent.trim();
                        const customer = cells[6].textContent.trim();
                        const productName = cells[10].textContent.trim();
                        
                        const option = document.createElement('option');
                        option.value = orderNumber;
                        option.textContent = orderNumber;
                        option.dataset.productName = productName;
                        option.dataset.customer = customer;
                        deliveryOrderId.appendChild(option);
                    }
                });
            }
            
            // 从订单管理表格获取客户信息
            function populateCustomers() {
                const orderTable = document.getElementById('ordersTable');
                if (!orderTable) return;
                
                const rows = orderTable.querySelectorAll('tbody tr');
                const customers = new Set();
                
                // 收集所有唯一客户
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        // 根据新的表头顺序，客户在第7列（索引6）
                        const customer = cells[6].textContent.trim();
                        if (customer) {
                            customers.add(customer);
                        }
                    }
                });
                
                // 清空下拉框
                deliveryCustomer.innerHTML = '<option value="">请选择客户</option>';
                
                // 添加客户选项
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    deliveryCustomer.appendChild(option);
                });
            }
            
            // 订单编号选中时自动填充产品名称和客户信息
            if (deliveryOrderId) {
                deliveryOrderId.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption) {
                        // 填充产品名称
                        if (selectedOption.dataset.productName) {
                            deliveryProduct.value = selectedOption.dataset.productName;
                        } else {
                            deliveryProduct.value = '';
                        }
                        
                        // 填充客户信息
                        if (selectedOption.dataset.customer) {
                            deliveryCustomer.value = selectedOption.dataset.customer;
                        } else {
                            deliveryCustomer.value = '';
                        }
                    } else {
                        deliveryProduct.value = '';
                        deliveryCustomer.value = '';
                    }
                });
            }
            
            // 根据类型控制输入框的只读状态
            function updateInputReadOnlyState() {
                const type = deliveryType.value;
                
                if (type === '发货') {
                    // 发货时：毛坯数量和返镀数量只读
                    deliveryRaw.readOnly = true;
                    deliveryReplate.readOnly = true;
                    deliveryElectroplate.readOnly = false;
                    deliveryRepair.readOnly = false;
                } else if (type === '收货') {
                    // 收货时：毛坯数量和返镀数量可编辑，电镀数量和返修数量只读
                    deliveryRaw.readOnly = false;
                    deliveryReplate.readOnly = false;
                    deliveryElectroplate.readOnly = true;
                    deliveryRepair.readOnly = true;
                } else {
                    // 未选择类型时，所有输入框都可编辑
                    deliveryRaw.readOnly = false;
                    deliveryReplate.readOnly = false;
                    deliveryElectroplate.readOnly = false;
                    deliveryRepair.readOnly = false;
                }
            }
            
            // 类型选择变化时更新输入框状态
            if (deliveryType) {
                deliveryType.addEventListener('change', updateInputReadOnlyState);
            }
            
            // 显示模态框
            if (addDeliveryBtn) {
                addDeliveryBtn.addEventListener('click', function() {
                    // 每次打开模态框时重新获取订单编号和客户信息
                    populateOrderNumbers();
                    populateCustomers();
                    // 更新输入框只读状态
                    updateInputReadOnlyState();
                    addDeliveryModal.classList.remove('hidden');
                });
            }
            
            // 隐藏模态框
            function hideDeliveryModal() {
                addDeliveryModal.classList.add('hidden');
                addDeliveryForm.reset();
            }
            
            // 点击取消按钮隐藏模态框
            if (cancelDeliveryBtn) {
                cancelDeliveryBtn.addEventListener('click', hideDeliveryModal);
            }
            
            // 点击关闭按钮隐藏模态框
            const closeDeliveryBtn = document.getElementById('close-delivery-modal');
            if (closeDeliveryBtn) {
                closeDeliveryBtn.addEventListener('click', hideDeliveryModal);
            }
            
            // 点击模态框外部隐藏模态框
            if (addDeliveryModal) {
                addDeliveryModal.addEventListener('click', function(e) {
                    if (e.target === addDeliveryModal) {
                        hideDeliveryModal();
                    }
                });
            }
            
            // 表单提交处理
            if (addDeliveryForm) {
                addDeliveryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const deliveryType = document.getElementById('delivery-type').value;
                    const orderNumber = deliveryOrderId.value;
                    
                    // 当类型为发货时，检查订单号是否存在于原始订单数据或收货记录中
                    if (deliveryType === '发货') {
                        const deliveriesData = tableConfigs.deliveries.originalData;
                        const ordersData = tableConfigs.orders.originalData;
                        let orderExists = false;
                        
                        // 首先检查原始订单数据中是否存在该订单号
                        for (let i = 0; i < ordersData.length; i++) {
                            const record = ordersData[i];
                            // 根据订单数据结构，订单编号在cells数组中
                            if (record.cells && record.cells.includes(orderNumber)) {
                                orderExists = true;
                                break;
                            }
                        }
                        
                        // 如果原始订单数据中不存在，再检查收货记录
                        if (!orderExists) {
                            for (let i = 0; i < deliveriesData.length; i++) {
                                const record = deliveriesData[i];
                                // cells[0] 是类型，cells[2] 是订单编号
                                if (record.cells[0] === '收货' && record.cells[2] === orderNumber) {
                                    orderExists = true;
                                    break;
                                }
                            }
                        }
                        
                        // 如果订单号不存在，显示提示并阻止保存
                        if (!orderExists) {
                            alert('无此订单号，请返回检查');
                            return; // 不关闭模态框
                        }
                    }
                    
                    // 获取完整表单数据
                    const deliveryData = {
                        type: deliveryType,
                        date: deliveryDate.value,
                        orderNumber: orderNumber,
                        customer: document.getElementById('delivery-customer').value,
                        productName: deliveryProduct.value,
                        roughQuantity: document.getElementById('delivery-raw').value,
                        electroplateQuantity: document.getElementById('delivery-electroplate').value,
                        replateQuantity: document.getElementById('delivery-replate').value,
                        repairQuantity: document.getElementById('delivery-repair').value,
                        scrapQuantity: document.getElementById('delivery-scrap').value,
                        remark: document.getElementById('delivery-remark').value
                    };
                    
                    // 保存数据到收发货管理表格
                    const deliveriesConfig = tableConfigs.deliveries;
                    
                    // 创建新的表格行数据
                    const newRowData = {
                        cells: [
                            deliveryData.type,              // 类型
                            deliveryData.date,              // 收发日期
                            deliveryData.orderNumber,       // 订单编号
                            deliveryData.customer,          // 客户名称
                            deliveryData.productName,       // 产品名称
                            deliveryData.roughQuantity,     // 毛坯数量
                            deliveryData.electroplateQuantity, // 电镀数量
                            deliveryData.replateQuantity,   // 返镀数量
                            deliveryData.repairQuantity,    // 修模数量
                            deliveryData.scrapQuantity,     // 报废数量
                            deliveryData.remark             // 备注
                        ]
                    };
                    
                    // 添加到原始数据和当前数据
                    deliveriesConfig.originalData.push(newRowData);
                    deliveriesConfig.data.push(newRowData);
                    
                    // 保存到localStorage
                    localStorage.setItem('deliveriesData', JSON.stringify(deliveriesConfig.originalData));
                    
                    // 重新渲染表格
                    renderTable('deliveries');
                    
                    // 自动计算并更新订单管理表格中的滞留数量
                    updateOrderRetainQuantity();
                    
                    // 显示保存成功提示
                    alert('收发货单保存成功！');
                    
                    // 隐藏模态框
                    hideDeliveryModal();
                });
            }
            

        });
    </script>
    <style>
        /* 去除数量输入框的微调按钮 */
        input[type="number"].no-spin-button::-webkit-inner-spin-button,
        input[type="number"].no-spin-button::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"].no-spin-button {
            -moz-appearance: textfield;
        }
        
        /* 为只读状态的输入框添加背景色 */
        input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
    </style>
                    </div>
                </form>
            </div>
        </div>
    <!-- 新建收发货单模态框 -->
    <div id="add-delivery-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto z-10">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">新建收发货单</h3>
                <button id="close-delivery-modal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="add-delivery-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="delivery-type" class="block text-sm font-medium text-gray-700 mb-1">类型</label>
                        <select id="delivery-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">请选择类型</option>
                            <option value="发货">发货</option>
                            <option value="收货">收货</option>
                        </select>
                    </div>
                    <div>
                        <label for="delivery-date" class="block text-sm font-medium text-gray-700 mb-1">收发日期</label>
                        <input type="date" id="delivery-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="delivery-order-id" class="block text-sm font-medium text-gray-700 mb-1">订单编号</label>
                        <select id="delivery-order-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">请选择订单编号</option>
                        </select>
                    </div>
                    <div>
                        <label for="delivery-customer" class="block text-sm font-medium text-gray-700 mb-1">客户</label>
                        <select id="delivery-customer" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">请选择客户</option>
                            <option value="深圳科技有限公司">深圳科技有限公司</option>
                            <option value="广州电子有限公司">广州电子有限公司</option>
                            <option value="东莞精密制造有限公司">东莞精密制造有限公司</option>
                            <option value="佛山金属制品有限公司">佛山金属制品有限公司</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="delivery-product" class="block text-sm font-medium text-gray-700 mb-1">产品名称</label>
                    <input type="text" id="delivery-product" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div>
                        <label for="delivery-raw" class="block text-sm font-medium text-gray-700 mb-1">毛坯数量</label>
                        <input type="number" id="delivery-raw" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary no-spin-button" min="0" step="1" required>
                    </div>
                    <div>
                        <label for="delivery-electroplate" class="block text-sm font-medium text-gray-700 mb-1">电镀数量</label>
                        <input type="number" id="delivery-electroplate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary no-spin-button" min="0" step="1" required>
                    </div>
                    <div>
                        <label for="delivery-replate" class="block text-sm font-medium text-gray-700 mb-1">返镀数量</label>
                        <input type="number" id="delivery-replate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary no-spin-button" min="0" step="1" required>
                    </div>
                    <div>
                        <label for="delivery-repair" class="block text-sm font-medium text-gray-700 mb-1">返修数量</label>
                        <input type="number" id="delivery-repair" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary no-spin-button" min="0" step="1" required>
                    </div>
                    <div>
                        <label for="delivery-scrap" class="block text-sm font-medium text-gray-700 mb-1">报废数量</label>
                        <input type="number" id="delivery-scrap" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary no-spin-button" min="0" step="1" required>
                    </div>
                </div>
                <div>
                    <label for="delivery-remark" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="delivery-remark" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-delivery" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        取消
                    </button>
                    <button type="submit" class="btn-primary">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 数据管理功能脚本 -->
    <script>
        // 数据管理下拉菜单
        const dataManagementBtn = document.getElementById('dataManagementBtn');
        const dataManagementMenu = document.getElementById('dataManagementMenu');

        dataManagementBtn.addEventListener('click', () => {
            dataManagementMenu.classList.toggle('hidden');
        });

        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!dataManagementBtn.contains(e.target) && !dataManagementMenu.contains(e.target)) {
                dataManagementMenu.classList.add('hidden');
            }
        });

        // 备份数据功能
        const backupDataBtn = document.getElementById('backupData');

        backupDataBtn.addEventListener('click', () => {
            // 获取所有localStorage数据
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            // 创建JSON字符串
            const jsonData = JSON.stringify(allData, null, 2);
            
            // 创建下载链接
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ydyf_backup_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.json`;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('数据备份成功！');
        });

        // 恢复数据功能
        const restoreDataBtn = document.getElementById('restoreData');
        const restoreFileInput = document.getElementById('restoreFileInput');

        restoreDataBtn.addEventListener('click', () => {
            restoreFileInput.click();
        });

        restoreFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // 清空当前localStorage
                    localStorage.clear();
                    
                    // 恢复所有数据
                    for (const key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    
                    alert('数据恢复成功！页面将刷新以显示恢复后的数据。');
                    window.location.reload();
                } catch (error) {
                    alert('数据恢复失败！请检查文件格式是否正确。');
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            e.target.value = '';
        });

        // 新建送货安排模态框功能
        // 更新司机下拉框选项
        function updateDriverDropdowns() {
            const config = tableConfigs.shipments;
            const shipments = config.originalData;
            
            // 提取所有司机名称并去重（司机信息位于cells数组的第5列，索引为4）
            const drivers = [...new Set(shipments.map(shipment => shipment.cells[4]).filter(driver => driver && driver.trim() !== ''))];
            
            // 获取司机筛选下拉框
            const filterDropdown = document.getElementById('shipments-driver-filter');
            if (filterDropdown) {
                // 清空下拉框，保留"所有司机"选项
                filterDropdown.innerHTML = '<option value="">所有司机</option>';
                
                // 添加司机选项
                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver;
                    option.textContent = driver;
                    filterDropdown.appendChild(option);
                });
            }
        }
        
        // 更新表格函数
        // 全局函数定义，用于操作送货安排
        function editShipment(index) {
            // 获取DOM元素
            const shipmentModal = document.getElementById('add-shipment-modal');
            const shipmentForm = document.getElementById('add-shipment-form');
            
            // 从tableConfigs获取数据
            const config = tableConfigs.shipments;
            const shipments = [...config.originalData];
            const shipment = shipments[index];
            
            if (!shipment) return;
            
            // 填充表单数据
            // 支持两种数据格式：有cells数组的旧格式和没有cells数组的新格式
            if (shipment.cells && Array.isArray(shipment.cells)) {
                // 旧格式：使用cells数组
                const cells = shipment.cells;
                document.getElementById('shipment-order-id').value = cells[0]; // 订单编号
                document.getElementById('shipment-customer').value = cells[1]; // 客户
                // 编辑时显示当前路线（箭头连接），并转换为逗号分隔格式
                const currentRoute = String(cells[2]);
                const commaSeparatedRoute = currentRoute.replace(/\s*→\s*/g, ',');
                document.getElementById('shipment-route').value = commaSeparatedRoute;
                document.getElementById('shipment-date').value = cells[3]; // 送货日期
                document.getElementById('shipment-driver').value = cells[4]; // 司机
                document.getElementById('shipment-phone').value = cells[5]; // 电话
                document.getElementById('shipment-license').value = cells[6]; // 车牌
                document.getElementById('shipment-cost').value = String(cells[7]).replace(/[¥\s]/g, ''); // 费用（移除¥符号和空格，确保是字符串类型）
                document.getElementById('shipment-remarks').value = cells[8]; // 备注
            } else {
                // 新格式：直接使用对象属性
                document.getElementById('shipment-order-id').value = shipment.orderId || ''; // 订单编号
                document.getElementById('shipment-customer').value = shipment.customer || ''; // 客户
                // 编辑时显示当前路线（逗号分隔）
                const currentRoute = shipment.originalRoute || shipment.route || '';
                const commaSeparatedRoute = String(currentRoute).replace(/\s*→\s*/g, ',');
                document.getElementById('shipment-route').value = commaSeparatedRoute;
                document.getElementById('shipment-date').value = shipment.date || ''; // 送货日期
                document.getElementById('shipment-driver').value = shipment.driver || ''; // 司机
                document.getElementById('shipment-phone').value = shipment.phone || ''; // 电话
                document.getElementById('shipment-license').value = shipment.license || ''; // 车牌
                document.getElementById('shipment-cost').value = String(shipment.cost || '').replace(/[¥\s]/g, ''); // 费用（移除¥符号和空格，确保是字符串类型）
                document.getElementById('shipment-remarks').value = shipment.remarks || ''; // 备注
            }
            
            // 动态修改模态框标题为编辑
            document.querySelector('#add-shipment-modal h3').textContent = '编辑送货安排';
            
            // 打开模态框
            shipmentModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // 添加编辑模式标记
            shipmentForm.dataset.editMode = 'true';
            shipmentForm.dataset.editIndex = index;
            
            // 编辑模式下的临时提交处理函数
            function editSubmitHandler(e) {
                e.preventDefault();
                
                // 获取表单数据
                const orderId = document.getElementById('shipment-order-id').value;
                const customer = document.getElementById('shipment-customer').value;
                const route = document.getElementById('shipment-route').value;
                // 转换路线格式：逗号分隔转为箭头连接
                const formattedRoute = route.split(',').map(part => part.trim()).join(' → ');
                const date = document.getElementById('shipment-date').value;
                const driver = document.getElementById('shipment-driver').value;
                const phone = document.getElementById('shipment-phone').value;
                const license = document.getElementById('shipment-license').value;
                const cost = parseFloat(document.getElementById('shipment-cost').value) || 0;
                const remarks = document.getElementById('shipment-remarks').value;
                
                // 格式化费用为货币形式
                const formattedCost = `¥ ${formatNumber(cost, 2)}`;
                
                // 更新数据
                // 支持两种数据格式：有cells数组的旧格式和没有cells数组的新格式
                if (shipment.cells && Array.isArray(shipment.cells)) {
                    // 旧格式：更新cells数组
                    shipment.cells[0] = orderId;
                    shipment.cells[1] = customer;
                    shipment.cells[2] = formattedRoute;
                    shipment.cells[3] = date;
                    shipment.cells[4] = driver;
                    shipment.cells[5] = phone;
                    shipment.cells[6] = license;
                    shipment.cells[7] = formattedCost;
                    shipment.cells[8] = remarks;
                    
                    // 更新对象属性
                    shipment.orderId = orderId;
                    shipment.customer = customer;
                    shipment.route = formattedRoute;
                    shipment.originalRoute = route;
                    shipment.date = date;
                    shipment.driver = driver;
                    shipment.phone = phone;
                    shipment.license = license;
                    shipment.cost = cost;
                    shipment.remarks = remarks;
                } else {
                    // 新格式：直接更新对象属性
                    shipment.orderId = orderId;
                    shipment.customer = customer;
                    shipment.route = formattedRoute;
                    shipment.originalRoute = route;
                    shipment.date = date;
                    shipment.driver = driver;
                    shipment.phone = phone;
                    shipment.license = license;
                    shipment.cost = cost;
                    shipment.remarks = remarks;
                    
                    // 确保cells数组格式正确，用于表格渲染
                    shipment.cells = [
                        orderId, // 订单编号
                        customer, // 客户
                        formattedRoute, // 路线
                        date, // 送货日期
                        driver, // 司机
                        phone, // 电话
                        license, // 车牌
                        formattedCost, // 费用
                        remarks, // 备注
                        '' // 操作列
                    ];
                }
                
                // 保存到localStorage
                localStorage.setItem('shipments', JSON.stringify(shipments));
                
                // 更新tableConfigs
                config.originalData = [...shipments];
                config.data = [...shipments];
                
                // 更新表格
                updateShipmentsTable();
                
                // 关闭模态框
                shipmentModal.classList.add('hidden');
                shipmentForm.reset();
                // 恢复模态框标题为新建
                document.querySelector('#add-shipment-modal h3').textContent = '新建送货安排';
                // 恢复页面滚动
                document.body.style.overflow = 'auto';
                
                // 移除编辑模式标记和临时事件监听器
                delete shipmentForm.dataset.editMode;
                delete shipmentForm.dataset.editIndex;
                shipmentForm.removeEventListener('submit', editSubmitHandler);
                
                // 显示成功提示
                showToast('送货安排更新成功！', 'success');
            }
            
            // 添加临时事件监听器
            shipmentForm.addEventListener('submit', editSubmitHandler);
        }
        
        function deleteShipment(index) {
            if (confirm('确定要删除这条送货安排吗？')) {
                // 从tableConfigs获取数据
                const config = tableConfigs.shipments;
                const shipments = [...config.originalData];
                shipments.splice(index, 1);
                localStorage.setItem('shipments', JSON.stringify(shipments));
                
                // 更新tableConfigs
                config.originalData = [...shipments];
                config.data = [...shipments];
                
                updateShipmentsTable();
                showToast('送货安排删除成功！', 'success');
            }
        }
        
        // 添加送货安排操作事件监听器
        function addShipmentActions() {
            // 编辑按钮事件
            const editButtons = document.querySelectorAll('.edit-shipment');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    editShipment(index);
                });
            });
            
            // 删除按钮事件
            const deleteButtons = document.querySelectorAll('.delete-shipment');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    deleteShipment(index);
                });
            });
        }
        
        function updateShipmentsTable() {
            // 重新加载数据并使用系统统一的renderTable函数渲染表格
            loadTableData('shipments');
            renderTable('shipments');
            
            // 更新司机下拉框选项
            updateDriverDropdowns();
            
            // 添加搜索事件监听器
            addSearchEventListeners('shipments');
            
            // 添加编辑和删除操作事件监听器
            addShipmentActions();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框元素
            const shipmentModal = document.getElementById('add-shipment-modal');
            const openShipmentModalBtn = document.getElementById('createShipmentBtn');
            const closeShipmentModalBtn = document.getElementById('close-shipment-modal');
            const cancelShipmentBtn = document.getElementById('cancel-shipment-btn');
            const shipmentForm = document.getElementById('add-shipment-form');
            const shipmentDate = document.getElementById('shipment-date');
            
            // 设置送货日期默认为今日
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            shipmentDate.value = formattedDate;
            
            // 新建发票模态框功能
            const invoiceModal = document.getElementById('add-invoice-modal');
            const openInvoiceModalBtn = document.getElementById('createInvoiceBtn');
            const closeInvoiceModalBtn = document.getElementById('close-invoice-modal');
            const cancelInvoiceBtn = document.getElementById('cancel-invoice-btn');
            const invoiceForm = document.getElementById('add-invoice-form');
            const invoiceDate = document.getElementById('invoice-date');
            
            // 设置开票日期默认为今日
            invoiceDate.value = formattedDate;
            
            // 打开模态框
            if (openShipmentModalBtn) {
                openShipmentModalBtn.addEventListener('click', function() {
                    // 恢复模态框标题为新建
                    document.querySelector('#add-shipment-modal h3').textContent = '新建送货安排';
                    shipmentModal.classList.remove('hidden');
                    // 添加防滚动效果
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // 关闭模态框
            function closeShipmentModal() {
                shipmentModal.classList.add('hidden');
                shipmentForm.reset();
                // 恢复模态框标题为新建
                document.querySelector('#add-shipment-modal h3').textContent = '新建送货安排';
                // 恢复页面滚动
                document.body.style.overflow = 'auto';
            }
            
            // 点击关闭按钮关闭模态框
            if (closeShipmentModalBtn) {
                closeShipmentModalBtn.addEventListener('click', closeShipmentModal);
            }
            if (cancelShipmentBtn) {
                cancelShipmentBtn.addEventListener('click', closeShipmentModal);
            }
            
            // 点击模态框外部关闭模态框
            shipmentModal.addEventListener('click', function(e) {
                // 检查点击的是否是遮罩层
                if (e.target.classList.contains('bg-gray-600')) {
                    closeShipmentModal();
                }
            });
            
        });
    
        // 从订单管理表格获取订单编号和客户信息，用于填充发票模态框
        function populateInvoiceOrderNumbers() {
            const orderTable = document.getElementById('ordersTable');
            if (!orderTable) return;
            
            const rows = orderTable.querySelectorAll('tbody tr');
            const invoiceOrderId = document.getElementById('invoice-order-id');
            
            // 从localStorage获取已有的发票数据，提取使用过的订单编号
            const storedInvoices = localStorage.getItem('invoices');
            const existingInvoiceOrders = new Set();
            
            if (storedInvoices) {
                const invoices = JSON.parse(storedInvoices);
                invoices.forEach(invoice => {
                    // 发票数据中的订单编号在cells数组的索引2
                    if (invoice.cells && invoice.cells.length >= 3) {
                        existingInvoiceOrders.add(invoice.cells[2]);
                    }
                });
            }
            
            // 获取当前编辑的索引
            const editIndex = document.getElementById('add-invoice-form').dataset.editIndex;
            
            // 清空下拉框
            invoiceOrderId.innerHTML = '<option value="">请选择订单编号</option>';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    // 根据新的表头顺序，订单编号在第6列（索引5），客户在第7列（索引6）
                    const orderNumber = cells[5].textContent.trim();
                    const customer = cells[6].textContent.trim();
                    
                    // 获取当前订单编号在发票中的索引
                    let isCurrentEditingOrder = false;
                    if (editIndex !== undefined && storedInvoices) {
                        const invoices = JSON.parse(storedInvoices);
                        const currentInvoice = invoices[editIndex];
                        if (currentInvoice && currentInvoice.cells && currentInvoice.cells[2] === orderNumber) {
                            isCurrentEditingOrder = true;
                        }
                    }
                    
                    // 添加尚未生成发票的订单编号，或当前正在编辑的订单编号
                    if (!existingInvoiceOrders.has(orderNumber) || isCurrentEditingOrder) {
                        const option = document.createElement('option');
                        option.value = orderNumber;
                        option.textContent = orderNumber;
                        option.dataset.customer = customer;
                        invoiceOrderId.appendChild(option);
                    }
                }
            });
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            // 重新获取元素，因为原来的变量在不同的作用域
            const openInvoiceModalBtn = document.getElementById('createInvoiceBtn');
            const invoiceModal = document.getElementById('add-invoice-modal');
            const closeInvoiceModalBtn = document.getElementById('close-invoice-modal');
            const cancelInvoiceBtn = document.getElementById('cancel-invoice-btn');
            const invoiceForm = document.getElementById('add-invoice-form');
            const shipmentForm = document.getElementById('add-shipment-form');
            const invoiceDate = document.getElementById('invoice-date');
            // 设置开票日期默认为今日
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            invoiceDate.value = formattedDate;
            
            // 打开发票模态框
            if (openInvoiceModalBtn) {
                openInvoiceModalBtn.addEventListener('click', function() {
                    document.querySelector('#add-invoice-modal h3').textContent = '新建发票';
                    // 填充订单编号下拉框
                    populateInvoiceOrderNumbers();
                    invoiceModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // 订单编号选中时自动填充客户信息
            const invoiceOrderId = document.getElementById('invoice-order-id');
            const invoiceCustomer = document.getElementById('invoice-customer');
            if (invoiceOrderId && invoiceCustomer) {
                invoiceOrderId.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset.customer) {
                        invoiceCustomer.value = selectedOption.dataset.customer;
                    } else {
                        invoiceCustomer.value = '';
                    }
                });
            }
            
            // 关闭发票模态框
            function closeInvoiceModal() {
                invoiceModal.classList.add('hidden');
                invoiceForm.reset();
                // 移除编辑索引
                delete invoiceForm.dataset.editIndex;
                document.querySelector('#add-invoice-modal h3').textContent = '新建发票';
                document.body.style.overflow = 'auto';
            }
            
            // 点击关闭按钮关闭发票模态框
            if (closeInvoiceModalBtn) {
                closeInvoiceModalBtn.addEventListener('click', closeInvoiceModal);
            }
            if (cancelInvoiceBtn) {
                cancelInvoiceBtn.addEventListener('click', closeInvoiceModal);
            }
            
            // 点击发票模态框外部关闭模态框
            invoiceModal.addEventListener('click', function(e) {
                if (e.target.classList.contains('bg-gray-600')) {
                    closeInvoiceModal();
                }
            });
            
            // 表单提交处理
            if (shipmentForm) {
                shipmentForm.addEventListener('submit', function(e) {
                    // 如果处于编辑模式，则不执行默认的新建逻辑
                    if (shipmentForm.dataset.editMode === 'true') {
                        return;
                    }
                    
                    e.preventDefault();
                    
                    // 获取表单数据
                    const orderId = document.getElementById('shipment-order-id').value;
                    const customer = document.getElementById('shipment-customer').value;
                    const route = document.getElementById('shipment-route').value;
                    const date = shipmentDate.value;
                    const driver = document.getElementById('shipment-driver').value;
                    const phone = document.getElementById('shipment-phone').value;
                    const license = document.getElementById('shipment-license').value;
                    const cost = parseFloat(document.getElementById('shipment-cost').value) || 0;
                    const remarks = document.getElementById('shipment-remarks').value;
                    
                    // 转换路线格式：逗号分隔转为箭头连接
                    const formattedRoute = route.split(',').map(part => part.trim()).join(' → ');
                    
                    // 创建送货安排对象，同时包含对象格式和cells数组格式，确保兼容性
                    // 格式化费用为货币形式
                    const formattedCost = `¥ ${formatNumber(cost, 2)}`;
                    
                    const shipment = {
                        orderId: orderId,
                        customer: customer,
                        route: formattedRoute, // 保存转换后的路线
                        originalRoute: route, // 保存原始路线（用于编辑）
                        date: date,
                        driver: driver,
                        phone: phone,
                        license: license,
                        cost: cost,
                        remarks: remarks,
                        // 同时保存cells数组格式，确保renderTable能正确渲染
                        cells: [
                            orderId, // 订单编号
                            customer, // 客户
                            formattedRoute, // 路线
                            date, // 送货日期
                            driver, // 司机
                            phone, // 电话
                            license, // 车牌
                            formattedCost, // 费用（格式化显示）
                            remarks, // 备注
                            '' // 操作列（空字符串，后续会动态生成）
                        ]
                    };
                    
                    // 保存到localStorage
                    let shipments = JSON.parse(localStorage.getItem('shipments')) || [];
                    shipments.push(shipment);
                    localStorage.setItem('shipments', JSON.stringify(shipments));
                    
                    // 更新tableConfigs
                    const config = tableConfigs.shipments;
                    config.originalData = [...shipments];
                    config.data = [...shipments];
                    
                    // 更新表格
                    updateShipmentsTable();
                    
                    // 关闭模态框
                    closeShipmentModal();
                    
                    // 显示成功提示
                    showToast('送货安排创建成功！', 'success');
                });
            }
            
            // 发票表单提交处理
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const orderId = document.getElementById('invoice-order-id').value;
                    const customer = document.getElementById('invoice-customer').value;
                    const date = invoiceDate.value;
                    const number = document.getElementById('invoice-number').value;
                    const amount = parseFloat(document.getElementById('invoice-amount').value) || 0;
                    const remarks = document.getElementById('invoice-remarks').value;
                    
                    // 格式化金额为货币形式
                    const formattedAmount = `¥ ${formatNumber(amount, 2)}`;
                    
                    // 创建发票对象
                    const invoice = {
                        orderId: orderId,
                        customer: customer,
                        date: date,
                        number: number,
                        amount: amount,
                        remarks: remarks,
                        status: '已开票', // 默认状态为已开票
                        // 保存cells数组格式，确保renderTable能正确渲染
                        cells: [
                            '已开票', // 付款状态
                            '', // 付款日期（留空）
                            orderId, // 订单编号
                            customer, // 客户
                            date, // 开票日期
                            number, // 发票号
                            formattedAmount, // 金额（格式化显示）
                            remarks, // 备注
                            '' // 操作列（空字符串，后续会动态生成）
                        ]
                    };
                    
                    // 为发票对象添加操作列
                    const editButton = '<button class="text-gray-500 hover:text-gray-700 mr-3 edit-button"><i class="fa fa-edit"></i></button>';
                    const deleteButton = '<button class="text-danger hover:text-danger/80 delete-button"><i class="fa fa-trash"></i></button>';
                    invoice.cells[8] = editButton + deleteButton;
                    
                    // 获取编辑索引
                    const editIndex = invoiceForm.dataset.editIndex;
                    
                    // 保存到localStorage
                    let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                    
                    if (editIndex !== undefined) {
                        // 编辑现有发票
                        invoices[editIndex] = invoice;
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        
                        // 更新tableConfigs
                        const config = tableConfigs.invoices;
                        config.originalData = [...invoices];
                        config.data = [...invoices];
                        
                        // 更新表格
                        renderTable('invoices');
                        
                        // 关闭模态框
                        closeInvoiceModal();
                        
                        // 显示成功提示
                        showToast('发票编辑成功！', 'success');
                        
                        // 移除编辑索引
                        delete invoiceForm.dataset.editIndex;
                    } else {
                        // 创建新发票
                        invoices.push(invoice);
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        
                        // 更新tableConfigs
                        const config = tableConfigs.invoices;
                        config.originalData = [...invoices];
                        config.data = [...invoices];
                        
                        // 更新表格
                        renderTable('invoices');
                        
                        // 关闭模态框
                        closeInvoiceModal();
                        
                        // 显示成功提示
                        showToast('发票创建成功！', 'success');
                    }
                });
            }
            

            
            // 添加编辑和删除操作

            

            

            
            // 从收发货管理表格获取订单编号
            function populateShipmentOrderNumbers() {
                const orderSelect = document.getElementById('shipment-order-id');
                if (!orderSelect) return;
                
                // 获取收发货管理表格数据
                const deliveriesData = tableConfigs.deliveries.originalData;
                if (!deliveriesData || deliveriesData.length === 0) return;
                
                // 存储唯一的订单编号和对应的客户信息
                const orderMap = new Map();
                
                deliveriesData.forEach(delivery => {
                    if (delivery.cells && delivery.cells.length >= 4) {
                        const orderNumber = delivery.cells[2]; // 订单编号在第3列（索引2）
                        const customer = delivery.cells[3]; // 客户名称在第4列（索引3）
                        
                        if (orderNumber && !orderMap.has(orderNumber)) {
                            orderMap.set(orderNumber, customer);
                        }
                    }
                });
                
                // 清空并重新填充下拉框
                orderSelect.innerHTML = '<option value="">请选择订单编号</option>';
                
                orderMap.forEach((customer, orderNumber) => {
                    const option = document.createElement('option');
                    option.value = orderNumber;
                    option.textContent = orderNumber;
                    option.dataset.customer = customer;
                    orderSelect.appendChild(option);
                });
            }
            
            // 订单编号变化时自动填充客户信息
            document.getElementById('shipment-order-id').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const customerInput = document.getElementById('shipment-customer');
                
                if (selectedOption && selectedOption.dataset.customer) {
                    customerInput.value = selectedOption.dataset.customer;
                } else {
                    customerInput.value = '';
                }
            });
            
            // 初始化表格数据
            updateShipmentsTable();
            
            // 添加送货安排操作事件监听器
            function addShipmentActions() {
                // 编辑按钮事件
                const editButtons = document.querySelectorAll('.edit-shipment');
                editButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        editShipment(index);
                    });
                });
                
                // 删除按钮事件
                const deleteButtons = document.querySelectorAll('.delete-shipment');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        deleteShipment(index);
                    });
                });
            }
            
            // 填充订单编号下拉框
            populateShipmentOrderNumbers();
            
            // 设置今天日期的函数
            function setTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                return formattedDate;
            }
            
            // 实现司机输入框的自动筛选功能
            const driverInput = document.getElementById('shipment-driver');
            const driverSuggestions = document.getElementById('driver-suggestions');
            
            // 存储司机信息的映射
            const driverMap = new Map();
            
            // 更新司机信息映射
            function updateDriverMap() {
                const shipments = JSON.parse(localStorage.getItem('shipments')) || [];
                shipments.forEach(shipment => {
                    if (shipment.driver && !driverMap.has(shipment.driver)) {
                        driverMap.set(shipment.driver, {
                            phone: shipment.phone,
                            license: shipment.license
                        });
                    }
                });
            }
            
            // 显示司机建议列表
            function showDriverSuggestions(query) {
                updateDriverMap();
                
                const filteredDrivers = Array.from(driverMap.keys()).filter(driver => 
                    driver.toLowerCase().includes(query.toLowerCase())
                );
                
                driverSuggestions.innerHTML = '';
                
                if (filteredDrivers.length > 0) {
                    filteredDrivers.forEach(driver => {
                        const div = document.createElement('div');
                        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';
                        div.textContent = driver;
                        div.addEventListener('click', () => {
                            driverInput.value = driver;
                            driverSuggestions.classList.add('hidden');
                            // 自动填充电话和车牌
                            const driverInfo = driverMap.get(driver);
                            if (driverInfo) {
                                document.getElementById('shipment-phone').value = driverInfo.phone || '';
                                document.getElementById('shipment-license').value = driverInfo.license || '';
                            }
                        });
                        driverSuggestions.appendChild(div);
                    });
                    driverSuggestions.classList.remove('hidden');
                } else {
                    driverSuggestions.classList.add('hidden');
                }
            }
            
            // 司机输入事件监听
            driverInput.addEventListener('input', function() {
                const query = this.value;
                if (query.length > 0) {
                    showDriverSuggestions(query);
                } else {
                    driverSuggestions.classList.add('hidden');
                }
            });
            
            // 点击外部关闭司机建议列表
            document.addEventListener('click', function(e) {
                if (!driverInput.contains(e.target) && !driverSuggestions.contains(e.target)) {
                    driverSuggestions.classList.add('hidden');
                }
            });
            
            // 当司机输入框失去焦点时，尝试根据输入内容自动填充电话和车牌
            driverInput.addEventListener('blur', function() {
                setTimeout(() => {
                    const driverName = this.value.trim();
                    if (driverName && driverMap.has(driverName)) {
                        const driverInfo = driverMap.get(driverName);
                        document.getElementById('shipment-phone').value = driverInfo.phone || '';
                        document.getElementById('shipment-license').value = driverInfo.license || '';
                    }
                }, 200);
            });
            
            // 当新建送货安排模态框打开时，重新填充订单编号并设置今天日期
            // 使用已经声明的openShipmentModalBtn变量，避免重复声明
            if (typeof openShipmentModalBtn !== 'undefined' && openShipmentModalBtn) {
                openShipmentModalBtn.addEventListener('click', function() {
                    populateShipmentOrderNumbers();
                    document.getElementById('shipment-date').value = setTodayDate();
                    // 清空司机输入框和相关信息
                    driverInput.value = '';
                    document.getElementById('shipment-phone').value = '';
                    document.getElementById('shipment-license').value = '';
                    if (driverSuggestions) {
                        driverSuggestions.classList.add('hidden');
                    }
                });
            }
            
            // 删除所有记录按钮功能
            const deleteAllBtn = document.getElementById('deleteAllShipmentsBtn');
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', function() {
                    if (confirm('确定要删除所有送货安排记录吗？此操作不可恢复！')) {
                        localStorage.removeItem('shipments');
                        // 直接调用loadTableData并传递createSampleData=false参数，防止重新创建示例数据
                        loadTableData('shipments', false);
                        renderTable('shipments');
                        updateDriverDropdowns();
                        addSearchEventListeners('shipments');
                        addShipmentActions();
                        showToast('所有送货安排记录已删除！', 'success');
                    }
                });
            }
        });

        // 全选/全不选功能
        function initSelectAllFeature() {
            // 订单管理表格全选功能
            const ordersSelectAll = document.getElementById('orders-select-all');
            if (ordersSelectAll) {
                ordersSelectAll.addEventListener('change', function() {
                    const orderCheckboxes = document.querySelectorAll('#ordersTableBody .table-row input[type="checkbox"]');
                    orderCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }
            
            // 收发货管理表格全选功能
            const deliveriesSelectAll = document.getElementById('deliveries-select-all');
            if (deliveriesSelectAll) {
                deliveriesSelectAll.addEventListener('change', function() {
                    const deliveryCheckboxes = document.querySelectorAll('#deliveriesTableBody .table-row input[type="checkbox"]');
                    deliveryCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }
        }
        
        // 页面加载完成后初始化全选功能
        document.addEventListener('DOMContentLoaded', function() {
            initSelectAllFeature();
            // 初始化送货安排表格和司机下拉框
            updateShipmentsTable();
        });
        
        // 显示Toast提示
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            
            // 设置图标和样式
            switch (type) {
                case 'success':
                    toast.className = 'toast toast-success show';
                    toastIcon.className = 'fa fa-check-circle mr-2';
                    break;
                case 'danger':
                    toast.className = 'toast toast-danger show';
                    toastIcon.className = 'fa fa-exclamation-circle mr-2';
                    break;
                case 'warning':
                    toast.className = 'toast toast-warning show';
                    toastIcon.className = 'fa fa-exclamation-triangle mr-2';
                    break;
                case 'info':
                    toast.className = 'toast toast-info show';
                    toastIcon.className = 'fa fa-info-circle mr-2';
                    break;
            }
            
            // 显示Toast
            toast.classList.add('show');
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>

    <!-- Toast 提示 -->
    <div id="toast" class="toast">
        <div class="flex items-center">
            <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <!-- 页脚 -->
    <div class="bg-primary text-white py-4">
        <div class="px-4 text-center">
            <div class="text-xs">Designed By AlonZhang</div>
            <div class="text-xs mt-1">Contact: 136 6511 9291</div>
        </div>
    </div>
</body>
</html>